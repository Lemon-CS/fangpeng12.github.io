<!DOCTYPE HTML>
<html lang="zh-CN">


<head>
    <meta charset="utf-8">
    <meta name="keywords" content="畅购商城（九）之权限验证, 空白格的博客">
    <meta name="description" content="第9章 Spring Security Oauth2 JWT学习目标
用户认证分析

认证技术方案了解

==SpringSecurity Oauth2.0入门==
oauth2.0认证模式
    授权码授权模式
    密码授权模式
授">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>畅购商城（九）之权限验证 | 空白格的博客</title>
    <link rel="icon" type="image/png" href="/favicon.png">

    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/all.css">
    <link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">
    
    <script src="/libs/jquery/jquery.min.js"></script>
    
<meta name="generator" content="Hexo 4.2.0"><link rel="alternate" href="/atom.xml" title="空白格的博客" type="application/atom+xml">
<link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css"></head>


<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper head-container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">空白格的博客</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>首页</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/tags" class="waves-effect waves-light">
      
      <i class="fas fa-tags" style="zoom: 0.6;"></i>
      
      <span>标签</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/categories" class="waves-effect waves-light">
      
      <i class="fas fa-bookmark" style="zoom: 0.6;"></i>
      
      <span>分类</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/archives" class="waves-effect waves-light">
      
      <i class="fas fa-archive" style="zoom: 0.6;"></i>
      
      <span>归档</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/about" class="waves-effect waves-light">
      
      <i class="fas fa-user-circle" style="zoom: 0.6;"></i>
      
      <span>关于</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/contact" class="waves-effect waves-light">
      
      <i class="fas fa-comments" style="zoom: 0.6;"></i>
      
      <span>留言板</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/friends" class="waves-effect waves-light">
      
      <i class="fas fa-address-book" style="zoom: 0.6;"></i>
      
      <span>友情链接</span>
    </a>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="搜索" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>

<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">空白格的博客</div>
        <div class="logo-desc">
            
            个人技术博客：主要是一些技术杂谈和学习笔记的分享
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			首页
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/tags" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-tags"></i>
			
			标签
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/categories" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-bookmark"></i>
			
			分类
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/archives" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-archive"></i>
			
			归档
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/about" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-user-circle"></i>
			
			关于
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/contact" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-comments"></i>
			
			Contact
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/friends" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-address-book"></i>
			
			友情链接
		</a>
          
        </li>
        
        
        <li><div class="divider"></div></li>
        <li>
            <a href="https://github.com/fangpeng12" class="waves-effect waves-light" target="_blank">
                <i class="fab fa-github-square fa-fw"></i>Fork Me
            </a>
        </li>
        
    </ul>
</div>

        </div>

        
            <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #36b3ec;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {
        0%,
        to {
            transform: rotate(0);
        }
        20%,
        60% {
            transform: rotate(-25deg);
        }
        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="https://github.com/fangpeng12" class="github-corner tooltipped hide-on-med-and-down" target="_blank"
   data-tooltip="Fork Me" data-position="left" data-delay="50">
    <svg viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor" class="octo-body"></path>
    </svg>
</a>
        
    </nav>

</header>

    



<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/7.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <div class="description center-align post-title">
                        畅购商城（九）之权限验证
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        margin: 35px 0 15px 0;
        padding-left: 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #toc-content .is-active-link::before {
        background-color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 15px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/%E5%BE%AE%E6%9C%8D%E5%8A%A1/">
                                <span class="chip bg-color">微服务</span>
                            </a>
                        
                            <a href="/tags/SpringCloud/">
                                <span class="chip bg-color">SpringCloud</span>
                            </a>
                        
                            <a href="/tags/%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98/">
                                <span class="chip bg-color">项目实战</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fas fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98/" class="post-category">
                                项目实战
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2020-03-17
                </div>
                

                

                
                <div class="info-break-policy">
                    <i class="far fa-file-word fa-fw"></i>文章字数:&nbsp;&nbsp;
                    7.7k
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-clock fa-fw"></i>阅读时长:&nbsp;&nbsp;
                    29 分
                </div>
                
				
                
                    <div id="busuanzi_container_page_pv" class="info-break-policy">
                        <i class="far fa-eye fa-fw"></i>阅读次数:&nbsp;&nbsp;
                        <span id="busuanzi_value_page_pv"></span>
                    </div>
				
            </div>
            
        </div>
        <hr class="clearfix">
        <div class="card-content article-card-content">
            <div id="articleContent">
                <h1 id="第9章-Spring-Security-Oauth2-JWT"><a href="#第9章-Spring-Security-Oauth2-JWT" class="headerlink" title="第9章 Spring Security Oauth2 JWT"></a>第9章 Spring Security Oauth2 JWT</h1><h2 id="学习目标"><a href="#学习目标" class="headerlink" title="学习目标"></a>学习目标</h2><ul>
<li><p>用户认证分析</p>
</li>
<li><p>认证技术方案了解</p>
</li>
<li><p>==SpringSecurity Oauth2.0入门==</p>
<pre><code>oauth2.0认证模式
    授权码授权模式
    密码授权模式
授权流程</code></pre></li>
<li><p>==用户授权认证开发==</p>
</li>
</ul>
<h2 id="1-用户认证分析"><a href="#1-用户认证分析" class="headerlink" title="1 用户认证分析"></a>1 用户认证分析</h2><p><img src="/2020/03/17/chang-gou-shang-cheng-shi-zhan-jiu/1558173244406.png" alt="用户认证分析"></p>
<p>上面流程图描述了用户要操作的各个微服务，用户查看个人信息需要访问客户微服务，下单需要访问订单微服务，秒杀抢购商品需要访问秒杀微服务。每个服务都需要认证用户的身份，身份认证成功后，需要识别用户的角色然后授权访问对应的功能。</p>
<h3 id="1-1-认证与授权"><a href="#1-1-认证与授权" class="headerlink" title="1.1 认证与授权"></a>1.1 认证与授权</h3><p><strong>身份认证</strong></p>
<p>用户身份认证即用户去访问系统资源时系统要求验证用户的身份信息，身份合法方可继续访问。常见的用户身份认证表现形式有：用户名密码登录，指纹打卡等方式。说通俗点，就相当于校验用户账号密码是否正确。</p>
<p><strong>用户授权</strong></p>
<p>用户认证通过后去访问系统的资源，系统会判断用户是否拥有访问资源的权限，只允许访问有权限的系统资源，没有权限的资源将无法访问，这个过程叫用户授权。</p>
<h3 id="1-2-单点登录"><a href="#1-2-单点登录" class="headerlink" title="1.2 单点登录"></a>1.2 单点登录</h3><p>用户访问的项目中，至少有3个微服务需要识别用户身份，如果用户访问每个微服务都登录一次就太麻烦了，为了提高用户的体验，我们需要实现让用户在一个系统中登录，其他任意受信任的系统都可以访问，这个功能就叫单点登录。</p>
<p>单点登录（Single Sign On），简称为 SSO，是目前比较流行的企业业务整合的解决方案之一。 SSO的定义是在多个应用系统中，用户只需要登录一次就可以访问所有相互信任的应用系统    </p>
<h3 id="1-3-第三方账号登录"><a href="#1-3-第三方账号登录" class="headerlink" title="1.3 第三方账号登录"></a>1.3 第三方账号登录</h3><h4 id="1-3-1-第三方登录介绍"><a href="#1-3-1-第三方登录介绍" class="headerlink" title="1.3.1 第三方登录介绍"></a>1.3.1 第三方登录介绍</h4><p>随着国内及国外巨头们的平台开放战略以及移动互联网的发展，第三方登录已经不是一个陌生的产品设计概念了。 所谓的第三方登录，是说基于用户在第三方平台上已有的账号和密码来快速完成己方应用的登录或者注册的功能。而这里的第三方平台，一般是已经拥有大量用户的平台，国外的比如Facebook，Twitter等，国内的比如微博、微信、QQ等。 </p>
<h4 id="1-3-2-第三方登录优点"><a href="#1-3-2-第三方登录优点" class="headerlink" title="1.3.2 第三方登录优点"></a>1.3.2 第三方登录优点</h4><pre><code>1.相比于本地注册，第三方登录一般来说比较方便、快捷，能够显著降低用户的注册和登录成本，方便用户实现快捷登录或注册。
2.不用费尽心思地应付本地注册对账户名和密码的各种限制，如果不考虑昵称的重复性要求，几乎可以直接一个账号走遍天下，再也不用在大脑或者什么地方记住N多不同的网站或App的账号和密码，整个世界一下子清静了。
3.在第一次绑定成功之后，之后用户便可以实现一键登录，使得后续的登录操作比起应用内的登录来容易了很多。
4.对于某些喜欢社交，并希望将更多自己的生活内容展示给朋友的人来说，第三方登录可以实现把用户在应用内的活动同步到第三方平台上，省去了用户手动发布动态的麻烦。但对于某些比较注重个人隐私的用户来说，则会有一些担忧，所以龙哥所说的这个优点是有前提的。
5.因为降低了用户的注册或登录成本，从而减少由于本地注册的繁琐性而带来的隐形用户流失，最终提高注册转化率。
6.对于某些应用来说，使用第三方登录完全可以满足自己的需要，因此不必要设计和开发一套自己的账户体系。
7.通过授权，可以通过在第三方平台上分享用户在应用内的活动在第三方平台上宣传自己，从而增加产品知名度。
8.通过授权，可以获得该用户在第三方平台上的好友或粉丝等社交信息，从而后续可以针对用户的社交关系网进行有目的性的营销宣传，为产品的市场推广提供另一种渠道。</code></pre><h4 id="1-3-3-第三方认证"><a href="#1-3-3-第三方认证" class="headerlink" title="1.3.3 第三方认证"></a>1.3.3 第三方认证</h4><p>当需要访问第三方系统的资源时需要首先通过第三方系统的认证（例如：微信认证），由第三方系统对用户认证通过，并授权资源的访问权限。</p>
<p><img src="/2020/03/17/chang-gou-shang-cheng-shi-zhan-jiu/1558174826405.png" alt="第三方认证"></p>
<h2 id="2-认证技术方案"><a href="#2-认证技术方案" class="headerlink" title="2 认证技术方案"></a>2 认证技术方案</h2><h3 id="2-1-单点登录技术方案"><a href="#2-1-单点登录技术方案" class="headerlink" title="2.1 单点登录技术方案"></a>2.1 单点登录技术方案</h3><p>分布式系统要实现单点登录，通常将认证系统独立抽取出来，并且将用户身份信息存储在单独的存储介质，比如： MySQL、Redis，考虑性能要求，通常存储在Redis中，如下图：</p>
<p><img src="/2020/03/17/chang-gou-shang-cheng-shi-zhan-jiu/1558175040643.png" alt="单点登录技术方案"></p>
<p>单点登录的特点是： </p>
<pre><code>1、认证系统为独立的系统。 
2、各子系统通过Http或其它协议与认证系统通信，完成用户认证。 
3、用户身份信息存储在Redis集群。</code></pre><p> Java中有很多用户认证的框架都可以实现单点登录：</p>
<pre><code> 1、Apache Shiro. 
 2、CAS 
 3、Spring security CAS    </code></pre><h3 id="2-2-Oauth2认证"><a href="#2-2-Oauth2认证" class="headerlink" title="2.2 Oauth2认证"></a>2.2 Oauth2认证</h3><p>OAuth（开放授权）是一个开放标准，允许用户授权第三方移动应用访问他们存储在另外的服务提供者上的信息，而不需要将用户名和密码提供给第三方移动应用或分享他们数据的所有内容，OAuth2.0是OAuth协议的延续版本。</p>
<h4 id="2-2-1-Oauth2认证流程"><a href="#2-2-1-Oauth2认证流程" class="headerlink" title="2.2.1 Oauth2认证流程"></a>2.2.1 Oauth2认证流程</h4><p>第三方认证技术方案最主要是解决认证协议的通用标准 问题，因为要实现 跨系统认证，各系统之间要遵循一定的接口协议。<br>OAUTH协议为用户资源的授权提供了一个安全的、开放而又简易的标准。同时，任何第三方都可以使用OAUTH认证服务，任何服务提供商都可以实现自身的OAUTH认证服务，因而OAUTH是开放的。业界提供了OAUTH的多种实现如PHP、JavaScript，Java，Ruby等各种语言开发包，大大节约了程序员的时间，因而OAUTH是简易的。互联网很多服务如Open API，很多大公司如Google，Yahoo，Microsoft等都提供了OAUTH认证服务，这些都足以说明OAUTH标准逐渐成为开放资源授权的标准。<br>Oauth协议目前发展到2.0版本，1.0版本过于复杂，2.0版本已得到广泛应用。<br>参考：<a href="https://baike.baidu.com/item/oAuth/7153134?fr=aladdin" target="_blank" rel="noopener">https://baike.baidu.com/item/oAuth/7153134?fr=aladdin</a><br>Oauth协议：<a href="https://tools.ietf.org/html/rfc6749" target="_blank" rel="noopener">https://tools.ietf.org/html/rfc6749</a><br>下边分析一个Oauth2认证的例子，黑马程序员网站使用微信认证的过程：</p>
<p><img src="/2020/03/17/chang-gou-shang-cheng-shi-zhan-jiu/1562394786067.png" alt="微信认证的过程"></p>
<p>1.客户端请求第三方授权</p>
<p>用户进入黑马程序的登录页面，点击微信的图标以微信账号登录系统，用户是自己在微信里信息的资源拥有者。</p>
<p>点击“用QQ账号登录”出现一个二维码，此时用户扫描二维码，开始给黑马程序员授权。    </p>
<p>2.资源拥有者同意给客户端授权</p>
<p>资源拥有者扫描二维码表示资源拥有者同意给客户端授权，微信会对资源拥有者的身份进行验证， 验证通过后，QQ会询问用户是否给授权黑马程序员访问自己的QQ数据，用户点击“确认登录”表示同意授权，QQ认证服务器会 颁发一个授权码，并重定向到黑马程序员的网站。    </p>
<p>3.客户端获取到授权码，请求认证服务器申请令牌 此过程用户看不到，客户端应用程序请求认证服务器，请求携带授权码。 </p>
<p>4.认证服务器向客户端响应令牌 认证服务器验证了客户端请求的授权码，如果合法则给客户端颁发令牌，令牌是客户端访问资源的通行证。 此交互过程用户看不到，当客户端拿到令牌后，用户在黑马程序员看到已经登录成功。 </p>
<p>5.客户端请求资源服务器的资源 客户端携带令牌访问资源服务器的资源。 黑马程序员网站携带令牌请求访问微信服务器获取用户的基本信息。 </p>
<p>6.资源服务器返回受保护资源 资源服务器校验令牌的合法性，如果合法则向用户响应资源信息内容。 注意：资源服务器和认证服务器可以是一个服务也可以分开的服务，如果是分开的服务资源服务器通常要请求认证 服务器来校验令牌的合法性。    </p>
<p>Oauth2.0认证流程如下： 引自Oauth2.0协议rfc6749 <a href="https://tools.ietf.org/html/rfc6749" target="_blank" rel="noopener">https://tools.ietf.org/html/rfc6749</a>    </p>
<p><img src="/2020/03/17/chang-gou-shang-cheng-shi-zhan-jiu/1558175981680.png" alt="Oauth2.0认证流程"></p>
<p>Oauth2包括以下角色： </p>
<p>1、客户端 本身不存储资源，需要通过资源拥有者的授权去请求资源服务器的资源，比如：畅购在线Android客户端、畅购在 线Web客户端（浏览器端）、微信客户端等。 </p>
<p>2、资源拥有者 通常为用户，也可以是应用程序，即该资源的拥有者。 </p>
<p>3、授权服务器（也称认证服务器） 用来对资源拥有的身份进行认证、对访问资源进行授权。客户端要想访问资源需要通过认证服务器由资源拥有者授 权后方可访问。 </p>
<p>4、资源服务器 存储资源的服务器，比如，畅购网用户管理服务器存储了畅购网的用户信息等。客户端最终访问资源服务器获取资源信息。    </p>
<h4 id="2-2-2-Oauth2在项目的应用"><a href="#2-2-2-Oauth2在项目的应用" class="headerlink" title="2.2.2 Oauth2在项目的应用"></a>2.2.2 Oauth2在项目的应用</h4><p>Oauth2是一个标准的开放的授权协议，应用程序可以根据自己的要求去使用Oauth2，本项目使用Oauth2实现如 下目标：</p>
<p>1、畅购访问第三方系统的资源 </p>
<p>2、外部系统访问畅购的资源 </p>
<p>3、畅购前端（客户端） 访问畅购微服务的资源。 </p>
<p>4、畅购微服务之间访问资源，例如：微服务A访问微服务B的资源，B访问A的资源。</p>
<h3 id="2-3-Spring-security-Oauth2认证解决方案"><a href="#2-3-Spring-security-Oauth2认证解决方案" class="headerlink" title="2.3 Spring security Oauth2认证解决方案"></a>2.3 Spring security Oauth2认证解决方案</h3><p>本项目采用 Spring security + Oauth2完成用户认证及用户授权，Spring security 是一个强大的和高度可定制的身份验证和访问控制框架，Spring security 框架集成了Oauth2协议，下图是项目认证架构图：    </p>
<p><img src="/2020/03/17/chang-gou-shang-cheng-shi-zhan-jiu/1558176649652.png" alt="项目认证架构图"></p>
<p>1、用户请求认证服务完成认证。 </p>
<p>2、认证服务下发用户身份令牌，拥有身份令牌表示身份合法。 </p>
<p>3、用户携带令牌请求资源服务，请求资源服务必先经过网关。 </p>
<p>4、网关校验用户身份令牌的合法，不合法表示用户没有登录，如果合法则放行继续访问。 </p>
<p>5、资源服务获取令牌，根据令牌完成授权。 </p>
<p>6、资源服务完成授权则响应资源信息。</p>
<h2 id="3-Security-Oauth2-0入门"><a href="#3-Security-Oauth2-0入门" class="headerlink" title="3 Security Oauth2.0入门"></a>3 Security Oauth2.0入门</h2><h3 id="3-1-学习知识点说明"><a href="#3-1-学习知识点说明" class="headerlink" title="3.1 学习知识点说明"></a>3.1 学习知识点说明</h3><p>本项目认证服务基于Spring Security Oauth2进行构建，并在其基础上作了一些扩展，采用JWT令牌机制，并自定 义了用户身份信息的内容。 本教程的主要目标是学习在项目中集成Spring Security Oauth2的方法和流程，通过 spring Security Oauth2的研究需要达到以下目标： </p>
<p>1、理解Oauth2的授权码认证流程及密码认证的流程。 </p>
<p>2、理解spring Security Oauth2的工作流程。 </p>
<p>3、掌握资源服务集成spring Security框架完成Oauth2认证的流程。</p>
<h3 id="3-2-搭建认证服务器"><a href="#3-2-搭建认证服务器" class="headerlink" title="3.2 搭建认证服务器"></a>3.2 搭建认证服务器</h3><p>关于oauth2.0服务搭建的详细流程，如果有兴趣可以参考课件中提供的oauth2.o搭建手册完成搭建。</p>
<h4 id="3-2-1-导入认证工程"><a href="#3-2-1-导入认证工程" class="headerlink" title="3.2.1 导入认证工程"></a>3.2.1 导入认证工程</h4><p>创建<code>changgou-user-oauth</code>的工程，如下图：</p>
<p><img src="/2020/03/17/chang-gou-shang-cheng-shi-zhan-jiu/1562408064151.png" alt="changgou-user-oauth"></p>
<h4 id="3-2-2-application-yml配置"><a href="#3-2-2-application-yml配置" class="headerlink" title="3.2.2 application.yml配置"></a>3.2.2 application.yml配置</h4><p><img src="/2020/03/17/chang-gou-shang-cheng-shi-zhan-jiu/1562462174678.png" alt="application.yml配置"></p>
<h4 id="3-2-2-启动授权认证服务"><a href="#3-2-2-启动授权认证服务" class="headerlink" title="3.2.2 启动授权认证服务"></a>3.2.2 启动授权认证服务</h4><p>启动之前，记得先启动eureka，再启动该授权认证工程。</p>
<h3 id="3-3-Oauth2授权模式"><a href="#3-3-Oauth2授权模式" class="headerlink" title="3.3 Oauth2授权模式"></a>3.3 Oauth2授权模式</h3><h4 id="3-3-1-Oauth2授权模式"><a href="#3-3-1-Oauth2授权模式" class="headerlink" title="3.3.1 Oauth2授权模式"></a>3.3.1 Oauth2授权模式</h4><p>Oauth2有以下授权模式： </p>
<pre class=" language-properties"><code class="language-properties"><span class="token attr-name">1.授权码模式（Authorization</span> <span class="token attr-value">Code）</span>
<span class="token attr-name">2.隐式授权模式（Implicit）</span> 
<span class="token attr-name">3.密码模式（Resource</span> <span class="token attr-value">Owner Password Credentials） </span>
<span class="token attr-name">4.客户端模式（Client</span> <span class="token attr-value">Credentials） </span></code></pre>
<p>其中授权码模式和密码模式应用较多，本小节介绍授权码模式。</p>
<h4 id="3-3-2-授权码授权实现"><a href="#3-3-2-授权码授权实现" class="headerlink" title="3.3.2 授权码授权实现"></a>3.3.2 授权码授权实现</h4><p>上边例举的黑马程序员网站使用QQ认证的过程就是授权码模式，流程如下： </p>
<p>1、客户端请求第三方授权 </p>
<p>2、用户(资源拥有者)同意给客户端授权 </p>
<p>3、客户端获取到授权码，请求认证服务器申请 令牌 </p>
<p>4、认证服务器向客户端响应令牌 </p>
<p>5、客户端请求资源服务器的资源，资源服务校验令牌合法性，完成授权 </p>
<p>6、资源服务器返回受保护资源    </p>
<p><strong>(1)申请授权码</strong></p>
<p>请求认证服务获取授权码：</p>
<pre><code>Get请求：
http://localhost:9001/oauth/authorize?client_id=changgou&amp;response_type=code&amp;scop=app&amp;redirect_uri=http://localhost</code></pre><p>参数列表如下： </p>
<pre class=" language-properties"><code class="language-properties"><span class="token attr-name">client_id：客户端id，和授权配置类中设置的客户端id一致。</span> 
<span class="token attr-name">response_type：授权码模式固定为code</span> 
<span class="token attr-name">scop：客户端范围，和授权配置类中设置的scop一致。</span> 
redirect_uri：跳转uri，当授权码申请成功后会跳转到此地址，并在后边带上code参数（授权码）</code></pre>
<p> 首先跳转到登录页面：</p>
<p><img src="/2020/03/17/chang-gou-shang-cheng-shi-zhan-jiu/1565035634997.png" alt="登录页面"></p>
<p>输入账号和密码，点击Login。 Spring Security接收到请求会调用UserDetailsService接口的loadUserByUsername方法查询用户正确的密码。 当前导入的基础工程中客户端ID为changgou，秘钥也为changgou即可认证通过。 </p>
<p>接下来进入授权页面：</p>
<p><img src="/2020/03/17/chang-gou-shang-cheng-shi-zhan-jiu/1565035586067.png" alt="授权页面">   </p>
<p>点击Authorize,接下来返回授权码： 认证服务携带授权码跳转redirect_uri,code=k45iLY就是返回的授权码</p>
<p><img src="/2020/03/17/chang-gou-shang-cheng-shi-zhan-jiu/1558181855325.png" alt="返回的授权码"></p>
<p><strong>(2)申请令牌</strong></p>
<p>拿到授权码后，申请令牌。 Post请求：<a href="http://localhost:9001/oauth/token" target="_blank" rel="noopener">http://localhost:9001/oauth/token</a> 参数如下： </p>
<pre><code>grant_type：授权类型，填写authorization_code，表示授权码模式 
code：授权码，就是刚刚获取的授权码，注意：授权码只使用一次就无效了，需要重新申请。 
redirect_uri：申请授权码时的跳转url，一定和申请授权码时用的redirect_uri一致。 </code></pre><p>此链接需要使用 http Basic认证。 什么是http Basic认证？ http协议定义的一种认证方式，将客户端id和客户端密码按照“客户端ID:客户端密码”的格式拼接，并用base64编 码，放在header中请求服务端，一个例子： Authorization：Basic WGNXZWJBcHA6WGNXZWJBcHA=WGNXZWJBcHA6WGNXZWJBcHA= 是用户名:密码的base64编码。 认证失败服务端返回 401 Unauthorized。</p>
<p>以上测试使用postman完成： </p>
<p>http basic认证：    </p>
<p><img src="/2020/03/17/chang-gou-shang-cheng-shi-zhan-jiu/1558182132328.png" alt="postman测试1"></p>
<p><img src="/2020/03/17/chang-gou-shang-cheng-shi-zhan-jiu/1558182177167.png" alt="postman测试2"></p>
<p>客户端Id和客户端密码会匹配数据库oauth_client_details表中的客户端id及客户端密码。    </p>
<p>点击发送： 申请令牌成功    </p>
<p><img src="/2020/03/17/chang-gou-shang-cheng-shi-zhan-jiu/1562408718454.png" alt="申请令牌成功"></p>
<p>返回信如下:</p>
<pre class=" language-properties"><code class="language-properties"><span class="token attr-name">access_token：访问令牌，携带此令牌访问资源</span> 
<span class="token attr-name">token_type：有MAC</span> <span class="token attr-value">Token与Bearer Token两种类型，两种的校验算法不同，RFC 6750建议Oauth2采用 Bearer Token（http://www.rfcreader.com/#rfc6750）。 </span>
<span class="token attr-name">refresh_token：刷新令牌，使用此令牌可以延长访问令牌的过期时间。</span> 
<span class="token attr-name">expires_in：过期时间，单位为秒。</span> 
<span class="token attr-name">scope：范围，与定义的客户端范围一致。</span> <span class="token attr-value">   </span>
jti：当前token的唯一标识</code></pre>
<p><strong>(3)令牌校验</strong></p>
<p>Spring Security Oauth2提供校验令牌的端点，如下： </p>
<p>Get: <a href="http://localhost:9001/oauth/check_token?token=" target="_blank" rel="noopener">http://localhost:9001/oauth/check_token?token=</a> [access_token]</p>
<p>参数： </p>
<p>token：令牌 </p>
<p>使用postman测试如下:</p>
<p><img src="/2020/03/17/chang-gou-shang-cheng-shi-zhan-jiu/1562409096845.png" alt="令牌校验"></p>
<p>如果令牌校验失败，会出现如下结果：</p>
<p><img src="/2020/03/17/chang-gou-shang-cheng-shi-zhan-jiu/1562409180948.png" alt="令牌校验失败"></p>
<p>如果令牌过期了，会如下如下结果：</p>
<p><img src="/2020/03/17/chang-gou-shang-cheng-shi-zhan-jiu/1562409507493.png" alt="令牌过期"></p>
<p><strong>(4)刷新令牌</strong></p>
<p>刷新令牌是当令牌快过期时重新生成一个令牌，它于授权码授权和密码授权生成令牌不同，刷新令牌不需要授权码 也不需要账号和密码，只需要一个刷新令牌、客户端id和客户端密码。 </p>
<p>测试如下： Post：<a href="http://localhost:9001/oauth/token" target="_blank" rel="noopener">http://localhost:9001/oauth/token</a> </p>
<p>参数：    </p>
<p>grant_type： 固定为 refresh_token </p>
<p>refresh_token：刷新令牌（注意不是access_token，而是refresh_token）    </p>
<p><img src="/2020/03/17/chang-gou-shang-cheng-shi-zhan-jiu/1562409616911.png" alt="刷新令牌"></p>
<h4 id="3-3-3-密码授权实现"><a href="#3-3-3-密码授权实现" class="headerlink" title="3.3.3 密码授权实现"></a>3.3.3 密码授权实现</h4><p><strong>(1)认证</strong></p>
<p>密码模式（Resource Owner Password Credentials）与授权码模式的区别是申请令牌不再使用授权码，而是直接 通过用户名和密码即可申请令牌。 </p>
<p>测试如下： </p>
<p>Post请求：<a href="http://localhost:9001/oauth/token" target="_blank" rel="noopener">http://localhost:9001/oauth/token</a> </p>
<p>参数： </p>
<p>grant_type：密码模式授权填写password </p>
<p>username：账号 </p>
<p>password：密码 </p>
<p>并且此链接需要使用 http Basic认证。</p>
<p><img src="/2020/03/17/chang-gou-shang-cheng-shi-zhan-jiu/1558221388787.png" alt="密码授权1"></p>
<p><img src="/2020/03/17/chang-gou-shang-cheng-shi-zhan-jiu/1558221423631.png" alt="密码授权2"></p>
<p>测试数据如下：</p>
<p><img src="/2020/03/17/chang-gou-shang-cheng-shi-zhan-jiu/1562462930730.png" alt="密码授权3"></p>
<p><strong>(2)校验令牌</strong></p>
<p>Spring Security Oauth2提供校验令牌的端点，如下： </p>
<p>Get: <a href="http://localhost:9001/oauth/check_token?token=" target="_blank" rel="noopener">http://localhost:9001/oauth/check_token?token=</a> </p>
<p>参数： </p>
<p>token：令牌 </p>
<p>使用postman测试如下:</p>
<p><img src="/2020/03/17/chang-gou-shang-cheng-shi-zhan-jiu/1558221673028.png" alt="密码授权校验"></p>
<p>返回结果：</p>
<pre class=" language-properties"><code class="language-properties">{
<span class="token attr-name">    "companyId"</span><span class="token punctuation">:</span> <span class="token attr-value">null,</span>
<span class="token attr-name">    "userpic"</span><span class="token punctuation">:</span> <span class="token attr-value">null,</span>
<span class="token attr-name">    "scope"</span><span class="token punctuation">:</span> <span class="token attr-value">[</span>
        "app"
    ],
<span class="token attr-name">    "name"</span><span class="token punctuation">:</span> <span class="token attr-value">null,</span>
<span class="token attr-name">    "utype"</span><span class="token punctuation">:</span> <span class="token attr-value">null,</span>
<span class="token attr-name">    "active"</span><span class="token punctuation">:</span> <span class="token attr-value">true,</span>
<span class="token attr-name">    "id"</span><span class="token punctuation">:</span> <span class="token attr-value">null,</span>
<span class="token attr-name">    "exp"</span><span class="token punctuation">:</span> <span class="token attr-value">1990221534,</span>
<span class="token attr-name">    "jti"</span><span class="token punctuation">:</span> <span class="token attr-value">"5b96666e-436b-4301-91b5-d89f9bbe6edb",</span>
<span class="token attr-name">    "client_id"</span><span class="token punctuation">:</span> <span class="token attr-value">"changgou",</span>
<span class="token attr-name">    "username"</span><span class="token punctuation">:</span> <span class="token attr-value">"szitheima"</span>
}</code></pre>
<p>exp：过期时间，long类型，距离1970年的秒数（new Date().getTime()可得到当前时间距离1970年的毫秒数）。 </p>
<p>user_name： 用户名 </p>
<p>client_id：客户端Id，在oauth_client_details中配置 </p>
<p>scope：客户端范围，在oauth_client_details表中配置 </p>
<p>jti：与令牌对应的唯一标识 companyId、userpic、name、utype、</p>
<p>id：这些字段是本认证服务在Spring Security基础上扩展的用户身份信息    </p>
<p><strong>(3)刷新令牌</strong></p>
<p>刷新令牌是当令牌快过期时重新生成一个令牌，它于授权码授权和密码授权生成令牌不同，刷新令牌不需要授权码 也不需要账号和密码，只需要一个刷新令牌、客户端id和客户端密码。 </p>
<p>测试如下： Post：<a href="http://localhost:9001/oauth/token" target="_blank" rel="noopener">http://localhost:9001/oauth/token</a> </p>
<p>参数：    </p>
<p>grant_type： 固定为 refresh_token </p>
<p>refresh_token：刷新令牌（注意不是access_token，而是refresh_token）    </p>
<p><img src="/2020/03/17/chang-gou-shang-cheng-shi-zhan-jiu/1558221864957.png" alt="密码授权刷新令牌"></p>
<p>刷新令牌成功，会重新生成新的访问令牌和刷新令牌，令牌的有效期也比旧令牌长。 </p>
<p>刷新令牌通常是在令牌快过期时进行刷新 。</p>
<h2 id="4-资源服务授权"><a href="#4-资源服务授权" class="headerlink" title="4 资源服务授权"></a>4 资源服务授权</h2><h3 id="4-1-资源服务授权流程"><a href="#4-1-资源服务授权流程" class="headerlink" title="4.1 资源服务授权流程"></a>4.1 资源服务授权流程</h3><p>(1)传统授权流程</p>
<p><img src="/2020/03/17/chang-gou-shang-cheng-shi-zhan-jiu/1562479275302.png" alt="传统授权流程"></p>
<p>资源服务器授权流程如上图，客户端先去授权服务器申请令牌，申请令牌后，携带令牌访问资源服务器，资源服务器访问授权服务校验令牌的合法性，授权服务会返回校验结果，如果校验成功会返回用户信息给资源服务器，资源服务器如果接收到的校验结果通过了，则返回资源给客户端。</p>
<p>传统授权方法的问题是用户每次请求资源服务，资源服务都需要携带令牌访问认证服务去校验令牌的合法性，并根 据令牌获取用户的相关信息，性能低下。 </p>
<p>(2)公钥私钥授权流程</p>
<p><img src="/2020/03/17/chang-gou-shang-cheng-shi-zhan-jiu/1562406193809.png" alt="公钥私钥授权流程"></p>
<p>传统的授权模式性能低下，每次都需要请求授权服务校验令牌合法性，我们可以利用公钥私钥完成对令牌的加密，如果加密解密成功，则表示令牌合法，如果加密解密失败，则表示令牌无效不合法，合法则允许访问资源服务器的资源，解密失败，则不允许访问资源服务器资源。</p>
<p>上图的业务流程如下:</p>
<pre class=" language-properties"><code class="language-properties">1、客户端请求认证服务申请令牌
2、认证服务生成令牌认证服务采用非对称加密算法，使用私钥生成令牌。
<span class="token attr-name">3、客户端携带令牌访问资源服务客户端在Http</span> <span class="token attr-value">header 中添加： Authorization：Bearer 令牌。</span>
4、资源服务请求认证服务校验令牌的有效性资源服务接收到令牌，使用公钥校验令牌的合法性。
5、令牌有效，资源服务向客户端响应资源信息</code></pre>
<h3 id="4-2-公钥私钥"><a href="#4-2-公钥私钥" class="headerlink" title="4.2 公钥私钥"></a>4.2 公钥私钥</h3><p>在对称加密的时代，加密和解密用的是同一个密钥，这个密钥既用于加密，又用于解密。这样做有一个明显的缺点，如果两个人之间传输文件，两个人都要知道密钥，如果是三个人呢，五个人呢？于是就产生了非对称加密，用一个密钥进行加密（公钥），用另一个密钥进行解密（私钥）。</p>
<h4 id="4-2-1-公钥私钥原理"><a href="#4-2-1-公钥私钥原理" class="headerlink" title="4.2.1 公钥私钥原理"></a>4.2.1 公钥私钥原理</h4><p>张三有两把钥匙，一把是公钥，另一把是私钥。</p>
<p><img src="/2020/03/17/chang-gou-shang-cheng-shi-zhan-jiu/1562470657125.png" alt="张三的两把钥匙"></p>
<p>张三把公钥送给他的朋友们—-李四、王五、赵六—-每人一把。</p>
<p><img src="/2020/03/17/chang-gou-shang-cheng-shi-zhan-jiu/1562470847506.png" alt="李四、王五、赵六"></p>
<p>李四要给张三写一封保密的信。她写完后用张三的公钥加密，就可以达到保密的效果。</p>
<p><img src="/2020/03/17/chang-gou-shang-cheng-shi-zhan-jiu/1562471063950.png" alt="1562471063950"></p>
<p>张三收信后，用私钥解密，就看到了信件内容。这里要强调的是，只要张三的私钥不泄露，这封信就是安全的，即使落在别人手里，也无法解密。</p>
<p><img src="/2020/03/17/chang-gou-shang-cheng-shi-zhan-jiu/1562471429501.png" alt="1562471429501"></p>
<p>张三给李四回信，决定采用”数字签名”。他写完后先用Hash函数，生成信件的摘要（digest）。张三将这个签名，附在信件下面，一起发给李四。</p>
<p><img src="/2020/03/17/chang-gou-shang-cheng-shi-zhan-jiu/1562472383322.png" alt="1562472383322"></p>
<p>李四收信后，取下数字签名，用张三的公钥解密，得到信件的摘要。由此证明，这封信确实是张三发出的。李四再对信件本身使用Hash函数，将得到的结果，与上一步得到的摘要进行对比。如果两者一致，就证明这封信未被修改过。</p>
<p><img src="/2020/03/17/chang-gou-shang-cheng-shi-zhan-jiu/1562472956514.png" alt="1562472956514"></p>
<h4 id="4-2-2-生成私钥公钥"><a href="#4-2-2-生成私钥公钥" class="headerlink" title="4.2.2 生成私钥公钥"></a>4.2.2 生成私钥公钥</h4><p>Spring Security 提供对JWT的支持，本节我们使用Spring Security 提供的JwtHelper来创建JWT令牌，校验JWT令牌 等操作。 这里JWT令牌我们采用非对称算法进行加密，所以我们要先生成公钥和私钥。</p>
<p>(1)生成密钥证书 下边命令生成密钥证书，采用RSA 算法每个证书包含公钥和私钥 </p>
<p>创建一个文件夹，在该文件夹下执行如下命令行：</p>
<pre class=" language-properties"><code class="language-properties"><span class="token attr-name">keytool</span> <span class="token attr-value">-genkeypair -alias changgou -keyalg RSA -keypass changgou -keystore changgou.jks -storepass changgou </span></code></pre>
<p>Keytool 是一个java提供的证书管理工具 </p>
<pre class=" language-properties"><code class="language-properties"><span class="token attr-name">-alias：密钥的别名</span> 
<span class="token attr-name">-keyalg：使用的hash算法</span> 
<span class="token attr-name">-keypass：密钥的访问密码</span> 
<span class="token attr-name">-keystore：密钥库文件名，xc.keystore保存了生成的证书</span> 
<span class="token attr-name">-storepass：密钥库的访问密码</span> </code></pre>
<p>(2)查询证书信息</p>
<pre class=" language-properties"><code class="language-properties"><span class="token attr-name">keytool</span> <span class="token attr-value">-list -keystore changgou.jks</span></code></pre>
<p>(3)删除别名 </p>
<pre class=" language-properties"><code class="language-properties"><span class="token attr-name">keytool</span> <span class="token attr-value">-delete -alias changgou -keystore changgou.jsk</span></code></pre>
<h4 id="4-2-3-导出公钥"><a href="#4-2-3-导出公钥" class="headerlink" title="4.2.3 导出公钥"></a>4.2.3 导出公钥</h4><p>openssl是一个加解密工具包，这里使用openssl来导出公钥信息。 </p>
<p>安装 openssl：<a href="http://slproweb.com/products/Win32OpenSSL.html" target="_blank" rel="noopener">http://slproweb.com/products/Win32OpenSSL.html</a> </p>
<p>安装资料目录下的Win64OpenSSL-1_1_0g.exe </p>
<p>配置openssl的path环境变量，如下图：</p>
<p><img src="/2020/03/17/chang-gou-shang-cheng-shi-zhan-jiu/1565037190408.png" alt="配置openssl"></p>
<p>本教程配置在C:\OpenSSL-Win64\bin</p>
<p>cmd进入changgou.jks文件所在目录执行如下命令(如下命令在windows下执行，会把-变成中文方式，请将它改成英文的-)： </p>
<pre class=" language-shell"><code class="language-shell">keytool -list -rfc --keystore changgou.jks | openssl x509 -inform pem -pubkey</code></pre>
<p>下面段内容是公钥</p>
<pre class=" language-properties"><code class="language-properties"><span class="token attr-name">-----BEGIN</span> <span class="token attr-value">PUBLIC KEY-----</span>
MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAvFsEiaLvij9C1Mz+oyAm
t47whAaRkRu/8kePM+X8760UGU0RMwGti6Z9y3LQ0RvK6I0brXmbGB/RsN38PVnh
cP8ZfxGUH26kX0RK+tlrxcrG+HkPYOH4XPAL8Q1lu1n9x3tLcIPxq8ZZtuIyKYEm
oLKyMsvTviG5flTpDprT25unWgE4md1kthRWXOnfWHATVY7Y/r4obiOL1mS5bEa/
iNKotQNnvIAKtjBM4RlIDWMa6dmz+lHtLtqDD2LF1qwoiSIHI75LQZ/CNYaHCfZS
xtOydpNKq8eb1/PGiLNolD4La2zf0/1dlcr5mkesV570NxRmU1tFm8Zd3MZlZmyv
9QIDAQAB
<span class="token attr-name">-----END</span> <span class="token attr-value">PUBLIC KEY-----</span></code></pre>
<p>将上边的公钥拷贝到文本public.key文件中，合并为一行,可以将它放到需要实现授权认证的工程中。</p>
<h4 id="4-2-4-JWT令牌"><a href="#4-2-4-JWT令牌" class="headerlink" title="4.2.4 JWT令牌"></a>4.2.4 JWT令牌</h4><p>(1)创建令牌数据</p>
<p>在changgou-user-oauth工程中创建测试类com.changgou.token.CreateJwtTest，使用它来创建令牌信息，代码如下：</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CreateJwtTest</span> <span class="token punctuation">{</span>

    <span class="token comment" spellcheck="true">/***
     * 创建令牌测试
     */</span>
    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testCreateToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">//证书文件路径</span>
        String key_location<span class="token operator">=</span><span class="token string">"changgou.jks"</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">//秘钥库密码</span>
        String key_password<span class="token operator">=</span><span class="token string">"changgou"</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">//秘钥密码</span>
        String keypwd <span class="token operator">=</span> <span class="token string">"changgou"</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">//秘钥别名</span>
        String alias <span class="token operator">=</span> <span class="token string">"changgou"</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">//访问证书路径</span>
        ClassPathResource resource <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ClassPathResource</span><span class="token punctuation">(</span>key_location<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">//创建秘钥工厂</span>
        KeyStoreKeyFactory keyStoreKeyFactory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">KeyStoreKeyFactory</span><span class="token punctuation">(</span>resource<span class="token punctuation">,</span>key_password<span class="token punctuation">.</span><span class="token function">toCharArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">//读取秘钥对(公钥、私钥)</span>
        KeyPair keyPair <span class="token operator">=</span> keyStoreKeyFactory<span class="token punctuation">.</span><span class="token function">getKeyPair</span><span class="token punctuation">(</span>alias<span class="token punctuation">,</span>keypwd<span class="token punctuation">.</span><span class="token function">toCharArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">//获取私钥</span>
        RSAPrivateKey rsaPrivate <span class="token operator">=</span> <span class="token punctuation">(</span>RSAPrivateKey<span class="token punctuation">)</span> keyPair<span class="token punctuation">.</span><span class="token function">getPrivate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">//定义Payload</span>
        Map<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Object<span class="token operator">></span> tokenMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        tokenMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"id"</span><span class="token punctuation">,</span> <span class="token string">"1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        tokenMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">,</span> <span class="token string">"itheima"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        tokenMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"roles"</span><span class="token punctuation">,</span> <span class="token string">"ROLE_VIP,ROLE_USER"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">//生成Jwt令牌</span>
        Jwt jwt <span class="token operator">=</span> JwtHelper<span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span>JSON<span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>tokenMap<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">RsaSigner</span><span class="token punctuation">(</span>rsaPrivate<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">//取出令牌</span>
        String encoded <span class="token operator">=</span> jwt<span class="token punctuation">.</span><span class="token function">getEncoded</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>encoded<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p>运行后的结果如下：</p>
<pre class=" language-properties"><code class="language-properties">eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.eyJyb2xlcyI6IlJPTEVfVklQLFJPTEVfVVNFUiIsIm5hbWUiOiJpdGhlaW1hIiwiaWQiOiIxIn0.IR9Qu9ZqYZ2gU2qgAziyT38UhEeL4Oi69ko-dzC_P9-Vjz40hwZDqxl8wZ-W2WAw1eWGIHV1EYDjg0-eilogJZ5UikyWw1bewXCpvlM-ZRtYQQqHFTlfDiVcFetyTayaskwa-x_BVS4pTWAskiaIKbKR4KcME2E5o1rEek-3YPkqAiZ6WP1UOmpaCJDaaFSdninqG0gzSCuGvLuG40x0Ngpfk7mPOecsIi5cbJElpdYUsCr9oXc53ROyfvYpHjzV7c2D5eIZu3leUPXRvvVAPJFEcSBiisxUSEeiGpmuQhaFZd1g-yJ1WQrixFvehMeLX2XU6W1nlL5ARTpQf_Jjiw</code></pre>
<p>(2)解析令牌</p>
<p>上面创建令牌后，我们可以对JWT令牌进行解析，这里解析需要用到公钥，我们可以将之前生成的公钥public.key拷贝出来用字符串变量token存储，然后通过公钥解密。</p>
<p>在changgou-user-oauth创建测试类com.changgou.token.ParseJwtTest实现解析校验令牌数据，代码如下：</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ParseJwtTest</span> <span class="token punctuation">{</span>

    <span class="token comment" spellcheck="true">/***
     * 校验令牌
     */</span>
    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testParseToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">//令牌</span>
        String token <span class="token operator">=</span> <span class="token string">"eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.eyJyb2xlcyI6IlJPTEVfVklQLFJPTEVfVVNFUiIsIm5hbWUiOiJpdGhlaW1hIiwiaWQiOiIxIn0.IR9Qu9ZqYZ2gU2qgAziyT38UhEeL4Oi69ko-dzC_P9-Vjz40hwZDqxl8wZ-W2WAw1eWGIHV1EYDjg0-eilogJZ5UikyWw1bewXCpvlM-ZRtYQQqHFTlfDiVcFetyTayaskwa-x_BVS4pTWAskiaIKbKR4KcME2E5o1rEek-3YPkqAiZ6WP1UOmpaCJDaaFSdninqG0gzSCuGvLuG40x0Ngpfk7mPOecsIi5cbJElpdYUsCr9oXc53ROyfvYpHjzV7c2D5eIZu3leUPXRvvVAPJFEcSBiisxUSEeiGpmuQhaFZd1g-yJ1WQrixFvehMeLX2XU6W1nlL5ARTpQf_Jjiw"</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">//公钥</span>
        String publickey <span class="token operator">=</span> <span class="token string">"-----BEGIN PUBLIC KEY-----MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAvFsEiaLvij9C1Mz+oyAmt47whAaRkRu/8kePM+X8760UGU0RMwGti6Z9y3LQ0RvK6I0brXmbGB/RsN38PVnhcP8ZfxGUH26kX0RK+tlrxcrG+HkPYOH4XPAL8Q1lu1n9x3tLcIPxq8ZZtuIyKYEmoLKyMsvTviG5flTpDprT25unWgE4md1kthRWXOnfWHATVY7Y/r4obiOL1mS5bEa/iNKotQNnvIAKtjBM4RlIDWMa6dmz+lHtLtqDD2LF1qwoiSIHI75LQZ/CNYaHCfZSxtOydpNKq8eb1/PGiLNolD4La2zf0/1dlcr5mkesV570NxRmU1tFm8Zd3MZlZmyv9QIDAQAB-----END PUBLIC KEY-----"</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">//校验Jwt</span>
        Jwt jwt <span class="token operator">=</span> JwtHelper<span class="token punctuation">.</span><span class="token function">decodeAndVerify</span><span class="token punctuation">(</span>token<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">RsaVerifier</span><span class="token punctuation">(</span>publickey<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">//获取Jwt原始内容</span>
        String claims <span class="token operator">=</span> jwt<span class="token punctuation">.</span><span class="token function">getClaims</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>claims<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">//jwt令牌</span>
        String encoded <span class="token operator">=</span> jwt<span class="token punctuation">.</span><span class="token function">getEncoded</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>encoded<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p>运行后的结果如下：</p>
<p><img src="/2020/03/17/chang-gou-shang-cheng-shi-zhan-jiu/1562478682563.png" alt="1562478682563"></p>
<h2 id="5-认证开发"><a href="#5-认证开发" class="headerlink" title="5 认证开发"></a>5 认证开发</h2><h3 id="5-1-需求分析"><a href="#5-1-需求分析" class="headerlink" title="5.1 需求分析"></a>5.1 需求分析</h3><p>用户登录的流程图如下：</p>
<p><img src="/2020/03/17/chang-gou-shang-cheng-shi-zhan-jiu/1562481462105.png" alt="用户登录的流程"></p>
<p>执行流程： </p>
<pre class=" language-properties"><code class="language-properties"><span class="token attr-name">1、用户登录，请求认证服务</span> 
<span class="token attr-name">2、认证服务认证通过，生成jwt令牌，将jwt令牌及相关信息写入cookie</span> 
<span class="token attr-name">3、用户访问资源页面，带着cookie到网关</span> 
<span class="token attr-name">4、网关从cookie获取token，如果存在token，则校验token合法性，如果不合法则拒绝访问，否则放行</span> 
<span class="token attr-name">5、用户退出，请求认证服务，删除cookie中的token</span> </code></pre>
<h3 id="5-2-认证服务"><a href="#5-2-认证服务" class="headerlink" title="5.2 认证服务"></a>5.2 认证服务</h3><h4 id="5-2-1-认证需求分析"><a href="#5-2-1-认证需求分析" class="headerlink" title="5.2.1 认证需求分析"></a>5.2.1 认证需求分析</h4><p>认证服务需要实现的功能如下： </p>
<p>1、登录接口 </p>
<p>前端post提交账号、密码等，用户身份校验通过，生成令牌，并将令牌写入cookie。 </p>
<p>2、退出接口 校验当前用户的身份为合法并且为已登录状态。 将令牌从cookie中删除。    </p>
<p><img src="/2020/03/17/chang-gou-shang-cheng-shi-zhan-jiu/1558224020588.png" alt="认证服务"></p>
<h4 id="5-2-2-工具封装"><a href="#5-2-2-工具封装" class="headerlink" title="5.2.2 工具封装"></a>5.2.2 工具封装</h4><p>在changgou-user-oauth工程中添加如下工具对象，方便操作令牌信息。</p>
<p>创建com.changgou.oauth.util.AuthToken类，存储用户令牌数据，代码如下：</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AuthToken</span> <span class="token keyword">implements</span> <span class="token class-name">Serializable</span><span class="token punctuation">{</span>

    <span class="token comment" spellcheck="true">//令牌信息</span>
    String accessToken<span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">//刷新token(refresh_token)</span>
    String refreshToken<span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">//jwt短令牌</span>
    String jti<span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">//...get...set</span>
<span class="token punctuation">}</span></code></pre>
<p>创建com.changgou.oauth.util.CookieUtil类，操作Cookie,代码如下：</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CookieUtil</span> <span class="token punctuation">{</span>

    <span class="token comment" spellcheck="true">/**
     * 设置cookie
     *
     * @param response
     * @param name     cookie名字
     * @param value    cookie值
     * @param maxAge   cookie生命周期 以秒为单位
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">addCookie</span><span class="token punctuation">(</span>HttpServletResponse response<span class="token punctuation">,</span> String domain<span class="token punctuation">,</span> String path<span class="token punctuation">,</span> String name<span class="token punctuation">,</span>
                                 String value<span class="token punctuation">,</span> <span class="token keyword">int</span> maxAge<span class="token punctuation">,</span> <span class="token keyword">boolean</span> httpOnly<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        Cookie cookie <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Cookie</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
        cookie<span class="token punctuation">.</span><span class="token function">setDomain</span><span class="token punctuation">(</span>domain<span class="token punctuation">)</span><span class="token punctuation">;</span>
        cookie<span class="token punctuation">.</span><span class="token function">setPath</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>
        cookie<span class="token punctuation">.</span><span class="token function">setMaxAge</span><span class="token punctuation">(</span>maxAge<span class="token punctuation">)</span><span class="token punctuation">;</span>
        cookie<span class="token punctuation">.</span><span class="token function">setHttpOnly</span><span class="token punctuation">(</span>httpOnly<span class="token punctuation">)</span><span class="token punctuation">;</span>
        response<span class="token punctuation">.</span><span class="token function">addCookie</span><span class="token punctuation">(</span>cookie<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">/**
     * 根据cookie名称读取cookie
     * @param request
     * @return map&lt;cookieName,cookieValue>
     */</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> Map<span class="token operator">&lt;</span>String<span class="token punctuation">,</span>String<span class="token operator">></span> <span class="token function">readCookie</span><span class="token punctuation">(</span>HttpServletRequest request<span class="token punctuation">,</span> String <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> cookieNames<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        Map<span class="token operator">&lt;</span>String<span class="token punctuation">,</span>String<span class="token operator">></span> cookieMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token operator">&lt;</span>String<span class="token punctuation">,</span>String<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            Cookie<span class="token punctuation">[</span><span class="token punctuation">]</span> cookies <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getCookies</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>cookies <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span>Cookie cookie <span class="token operator">:</span> cookies<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    String cookieName <span class="token operator">=</span> cookie<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    String cookieValue <span class="token operator">=</span> cookie<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>cookieNames<span class="token punctuation">.</span>length<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                        <span class="token keyword">if</span><span class="token punctuation">(</span>cookieNames<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>cookieName<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                            cookieMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>cookieName<span class="token punctuation">,</span>cookieValue<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token keyword">return</span> cookieMap<span class="token punctuation">;</span>

    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p>创建com.changgou.oauth.util.UserJwt类，封装SpringSecurity中User信息以及用户自身基本信息,代码如下：</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserJwt</span> <span class="token keyword">extends</span> <span class="token class-name">User</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> String id<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">//用户ID</span>
    <span class="token keyword">private</span> String name<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//用户名字</span>

    <span class="token keyword">public</span> <span class="token function">UserJwt</span><span class="token punctuation">(</span>String username<span class="token punctuation">,</span> String password<span class="token punctuation">,</span> Collection<span class="token operator">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">GrantedAuthority</span><span class="token operator">></span> authorities<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span>username<span class="token punctuation">,</span> password<span class="token punctuation">,</span> authorities<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">//...get...set</span>
<span class="token punctuation">}</span></code></pre>
<h4 id="5-2-3-业务层"><a href="#5-2-3-业务层" class="headerlink" title="5.2.3  业务层"></a>5.2.3  业务层</h4><p><img src="/2020/03/17/chang-gou-shang-cheng-shi-zhan-jiu/1562486044874.png" alt="认证流程"></p>
<p>如上图，我们现在实现一个认证流程，用户从页面输入账号密码，到认证服务的Controller层，Controller层调用Service层，Service层调用OAuth2.0的认证地址，进行密码授权认证操作，如果账号密码正确了，就返回令牌信息给Service层，Service将令牌信息给Controller层，Controller层将数据存入到Cookie中，再响应用户。</p>
<p>创建com.changgou.oauth.service.AuthService接口，并添加授权认证方法：</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">AuthService</span> <span class="token punctuation">{</span>

    <span class="token comment" spellcheck="true">/***
     * 授权认证方法
     */</span>
    AuthToken <span class="token function">login</span><span class="token punctuation">(</span>String username<span class="token punctuation">,</span> String password<span class="token punctuation">,</span> String clientId<span class="token punctuation">,</span> String clientSecret<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p>创建com.changgou.oauth.service.impl.AuthServiceImpl实现类，实现获取令牌数据，这里认证获取令牌采用的是密码授权模式，用的是RestTemplate向OAuth服务发起认证请求，代码如下：</p>
<pre class=" language-java"><code class="language-java"><span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AuthServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">AuthService</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> LoadBalancerClient loadBalancerClient<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> RestTemplate restTemplate<span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">/***
     * 授权认证方法
     * @param username
     * @param password
     * @param clientId
     * @param clientSecret
     * @return
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> AuthToken <span class="token function">login</span><span class="token punctuation">(</span>String username<span class="token punctuation">,</span> String password<span class="token punctuation">,</span> String clientId<span class="token punctuation">,</span> String clientSecret<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">//申请令牌</span>
        AuthToken authToken <span class="token operator">=</span> <span class="token function">applyToken</span><span class="token punctuation">(</span>username<span class="token punctuation">,</span>password<span class="token punctuation">,</span>clientId<span class="token punctuation">,</span> clientSecret<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>authToken <span class="token operator">==</span> null<span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"申请令牌失败"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> authToken<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token comment" spellcheck="true">/****
     * 认证方法
     * @param username:用户登录名字
     * @param password：用户密码
     * @param clientId：配置文件中的客户端ID
     * @param clientSecret：配置文件中的秘钥
     * @return
     */</span>
    <span class="token keyword">private</span> AuthToken <span class="token function">applyToken</span><span class="token punctuation">(</span>String username<span class="token punctuation">,</span> String password<span class="token punctuation">,</span> String clientId<span class="token punctuation">,</span> String clientSecret<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">//选中认证服务的地址</span>
        ServiceInstance serviceInstance <span class="token operator">=</span> loadBalancerClient<span class="token punctuation">.</span><span class="token function">choose</span><span class="token punctuation">(</span><span class="token string">"user-auth"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>serviceInstance <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"找不到对应的服务"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">//获取令牌的url</span>
        String path <span class="token operator">=</span> serviceInstance<span class="token punctuation">.</span><span class="token function">getUri</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"/oauth/token"</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">//定义body</span>
        MultiValueMap<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> String<span class="token operator">></span> formData <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedMultiValueMap</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">//授权方式</span>
        formData<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"grant_type"</span><span class="token punctuation">,</span> <span class="token string">"password"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">//账号</span>
        formData<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"username"</span><span class="token punctuation">,</span> username<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">//密码</span>
        formData<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"password"</span><span class="token punctuation">,</span> password<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">//定义头</span>
        MultiValueMap<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> String<span class="token operator">></span> header <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedMultiValueMap</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        header<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"Authorization"</span><span class="token punctuation">,</span> <span class="token function">httpbasic</span><span class="token punctuation">(</span>clientId<span class="token punctuation">,</span> clientSecret<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">//指定 restTemplate当遇到400或401响应时候也不要抛出异常，也要正常返回值</span>
        restTemplate<span class="token punctuation">.</span><span class="token function">setErrorHandler</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">DefaultResponseErrorHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handleError</span><span class="token punctuation">(</span>ClientHttpResponse response<span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">//当响应的值为400或401时候也要正常响应，不要抛出异常</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>response<span class="token punctuation">.</span><span class="token function">getRawStatusCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">400</span> <span class="token operator">&amp;&amp;</span> response<span class="token punctuation">.</span><span class="token function">getRawStatusCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">401</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">handleError</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        Map map <span class="token operator">=</span> null<span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">//http请求spring security的申请令牌接口</span>
            ResponseEntity<span class="token operator">&lt;</span>Map<span class="token operator">></span> mapResponseEntity <span class="token operator">=</span> restTemplate<span class="token punctuation">.</span><span class="token function">exchange</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> HttpMethod<span class="token punctuation">.</span>POST<span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token class-name">HttpEntity</span><span class="token operator">&lt;</span>MultiValueMap<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> String<span class="token operator">>></span><span class="token punctuation">(</span>formData<span class="token punctuation">,</span> header<span class="token punctuation">)</span><span class="token punctuation">,</span> Map<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">//获取响应数据</span>
            map <span class="token operator">=</span> mapResponseEntity<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RestClientException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>map <span class="token operator">==</span> null <span class="token operator">||</span> map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"access_token"</span><span class="token punctuation">)</span> <span class="token operator">==</span> null <span class="token operator">||</span> map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"refresh_token"</span><span class="token punctuation">)</span> <span class="token operator">==</span> null <span class="token operator">||</span> map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"jti"</span><span class="token punctuation">)</span> <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">//jti是jwt令牌的唯一标识作为用户身份令牌</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"创建令牌失败！"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment" spellcheck="true">//将响应数据封装成AuthToken对象</span>
        AuthToken authToken <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AuthToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">//访问令牌(jwt)</span>
        String accessToken <span class="token operator">=</span> <span class="token punctuation">(</span>String<span class="token punctuation">)</span> map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"access_token"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">//刷新令牌(jwt)</span>
        String refreshToken <span class="token operator">=</span> <span class="token punctuation">(</span>String<span class="token punctuation">)</span> map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"refresh_token"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">//jti，作为用户的身份标识</span>
        String jwtToken<span class="token operator">=</span> <span class="token punctuation">(</span>String<span class="token punctuation">)</span> map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"jti"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        authToken<span class="token punctuation">.</span><span class="token function">setJti</span><span class="token punctuation">(</span>jwtToken<span class="token punctuation">)</span><span class="token punctuation">;</span>
        authToken<span class="token punctuation">.</span><span class="token function">setAccessToken</span><span class="token punctuation">(</span>accessToken<span class="token punctuation">)</span><span class="token punctuation">;</span>
        authToken<span class="token punctuation">.</span><span class="token function">setRefreshToken</span><span class="token punctuation">(</span>refreshToken<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> authToken<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token comment" spellcheck="true">/***
     * base64编码
     * @param clientId
     * @param clientSecret
     * @return
     */</span>
    <span class="token keyword">private</span> String <span class="token function">httpbasic</span><span class="token punctuation">(</span>String clientId<span class="token punctuation">,</span>String clientSecret<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">//将客户端id和客户端密码拼接，按“客户端id:客户端密码”</span>
        String string <span class="token operator">=</span> clientId<span class="token operator">+</span><span class="token string">":"</span><span class="token operator">+</span>clientSecret<span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">//进行base64编码</span>
        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> encode <span class="token operator">=</span> Base64Utils<span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span>string<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token string">"Basic "</span><span class="token operator">+</span><span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>encode<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<h4 id="5-2-4-控制层"><a href="#5-2-4-控制层" class="headerlink" title="5.2.4  控制层"></a>5.2.4  控制层</h4><p>创建控制层com.changgou.oauth.controller.AuthController，编写用户登录授权方法，代码如下：</p>
<pre class=" language-java"><code class="language-java"><span class="token annotation punctuation">@RestController</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"/user"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AuthController</span> <span class="token punctuation">{</span>

    <span class="token comment" spellcheck="true">//客户端ID</span>
    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"${auth.clientId}"</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> String clientId<span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">//秘钥</span>
    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"${auth.clientSecret}"</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> String clientSecret<span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">//Cookie存储的域名</span>
    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"${auth.cookieDomain}"</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> String cookieDomain<span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">//Cookie生命周期</span>
    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"${auth.cookieMaxAge}"</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> cookieMaxAge<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    AuthService authService<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">"/login"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> Result <span class="token function">login</span><span class="token punctuation">(</span>String username<span class="token punctuation">,</span> String password<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>StringUtils<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>username<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"用户名不允许为空"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>StringUtils<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>password<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"密码不允许为空"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">//申请令牌</span>
        AuthToken authToken <span class="token operator">=</span>  authService<span class="token punctuation">.</span><span class="token function">login</span><span class="token punctuation">(</span>username<span class="token punctuation">,</span>password<span class="token punctuation">,</span>clientId<span class="token punctuation">,</span>clientSecret<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">//用户身份令牌</span>
        String access_token <span class="token operator">=</span> authToken<span class="token punctuation">.</span><span class="token function">getAccessToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">//将令牌存储到cookie</span>
        <span class="token function">saveCookie</span><span class="token punctuation">(</span>access_token<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Result</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span> StatusCode<span class="token punctuation">.</span>OK<span class="token punctuation">,</span><span class="token string">"登录成功！"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">/***
     * 将令牌存储到cookie
     * @param token
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">saveCookie</span><span class="token punctuation">(</span>String token<span class="token punctuation">)</span><span class="token punctuation">{</span>
        HttpServletResponse response <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>ServletRequestAttributes<span class="token punctuation">)</span> RequestContextHolder<span class="token punctuation">.</span><span class="token function">getRequestAttributes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        CookieUtil<span class="token punctuation">.</span><span class="token function">addCookie</span><span class="token punctuation">(</span>response<span class="token punctuation">,</span>cookieDomain<span class="token punctuation">,</span><span class="token string">"/"</span><span class="token punctuation">,</span><span class="token string">"Authorization"</span><span class="token punctuation">,</span>token<span class="token punctuation">,</span>cookieMaxAge<span class="token punctuation">,</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<h4 id="5-2-5-测试认证接口"><a href="#5-2-5-测试认证接口" class="headerlink" title="5.2.5 测试认证接口"></a>5.2.5 测试认证接口</h4><p>使用postman测试：</p>
<p> Post请求：<a href="http://localhost:9001/user/login" target="_blank" rel="noopener">http://localhost:9001/user/login</a>    </p>
<p><img src="/2020/03/17/chang-gou-shang-cheng-shi-zhan-jiu/1562489532494.png" alt="测试认证接口"></p>

            </div>
            <hr/>

            

    <div class="reprint" id="reprint-statement">
        
            <div class="reprint__author">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-user">
                        文章作者:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="https://fangpeng12.github.io" rel="external nofollow noreferrer">fangpeng</a>
                </span>
            </div>
            <div class="reprint__type">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-link">
                        文章链接:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="https://fangpeng12.github.io/2020/03/17/chang-gou-shang-cheng-shi-zhan-jiu/">https://fangpeng12.github.io/2020/03/17/chang-gou-shang-cheng-shi-zhan-jiu/</a>
                </span>
            </div>
            <div class="reprint__notice">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-copyright">
                        版权声明:
                    </i>
                </span>
                <span class="reprint-info">
                    本博客所有文章除特別声明外，均采用
                    <a href="https://creativecommons.org/licenses/by/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY 4.0</a>
                    许可协议。转载请注明来源
                    <a href="https://fangpeng12.github.io" target="_blank">fangpeng</a>
                    !
                </span>
            </div>
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>复制成功，请遵循本文的转载规则</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">查看</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>



            <div class="tag_share" style="display: block;">
                <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                            
                                <a href="/tags/%E5%BE%AE%E6%9C%8D%E5%8A%A1/">
                                    <span class="chip bg-color">微服务</span>
                                </a>
                            
                                <a href="/tags/SpringCloud/">
                                    <span class="chip bg-color">SpringCloud</span>
                                </a>
                            
                                <a href="/tags/%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98/">
                                    <span class="chip bg-color">项目实战</span>
                                </a>
                            
                        </div>
                    
                </div>
                <div class="post_share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">

<div id="article-share">
    
    
    <div class="social-share" data-sites="twitter,facebook,google,qq,qzone,wechat,weibo,douban,linkedin" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="/libs/share/js/social-share.min.js"></script>
    

    

</div>

                </div>
            </div>
            
                <style>
    #reward {
        margin: 40px 0;
        text-align: center;
    }

    #reward .reward-link {
        font-size: 1.4rem;
        line-height: 38px;
    }

    #reward .btn-floating:hover {
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2), 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    #rewardModal {
        width: 320px;
        height: 350px;
    }

    #rewardModal .reward-title {
        margin: 15px auto;
        padding-bottom: 5px;
    }

    #rewardModal .modal-content {
        padding: 10px;
    }

    #rewardModal .close {
        position: absolute;
        right: 15px;
        top: 15px;
        color: rgba(0, 0, 0, 0.5);
        font-size: 1.3rem;
        line-height: 20px;
        cursor: pointer;
    }

    #rewardModal .close:hover {
        color: #ef5350;
        transform: scale(1.3);
        -moz-transform:scale(1.3);
        -webkit-transform:scale(1.3);
        -o-transform:scale(1.3);
    }

    #rewardModal .reward-tabs {
        margin: 0 auto;
        width: 210px;
    }

    .reward-tabs .tabs {
        height: 38px;
        margin: 10px auto;
        padding-left: 0;
    }

    .reward-content ul {
        padding-left: 0 !important;
    }

    .reward-tabs .tabs .tab {
        height: 38px;
        line-height: 38px;
    }

    .reward-tabs .tab a {
        color: #fff;
        background-color: #ccc;
    }

    .reward-tabs .tab a:hover {
        background-color: #ccc;
        color: #fff;
    }

    .reward-tabs .wechat-tab .active {
        color: #fff !important;
        background-color: #22AB38 !important;
    }

    .reward-tabs .alipay-tab .active {
        color: #fff !important;
        background-color: #019FE8 !important;
    }

    .reward-tabs .reward-img {
        width: 210px;
        height: 210px;
    }
</style>

<div id="reward">
    <a href="#rewardModal" class="reward-link modal-trigger btn-floating btn-medium waves-effect waves-light red">赏</a>

    <!-- Modal Structure -->
    <div id="rewardModal" class="modal">
        <div class="modal-content">
            <a class="close modal-close"><i class="fas fa-times"></i></a>
            <h4 class="reward-title">你的赏识是我前进的动力</h4>
            <div class="reward-content">
                <div class="reward-tabs">
                    <ul class="tabs row">
                        <li class="tab col s6 alipay-tab waves-effect waves-light"><a href="#alipay">支付宝</a></li>
                        <li class="tab col s6 wechat-tab waves-effect waves-light"><a href="#wechat">微 信</a></li>
                    </ul>
                    <div id="alipay">
                        <img src="/medias/reward/alipay.jpg" class="reward-img" alt="支付宝打赏二维码">
                    </div>
                    <div id="wechat">
                        <img src="/medias/reward/wechat.png" class="reward-img" alt="微信打赏二维码">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    $(function () {
        $('.tabs').tabs();
    });
</script>
            
        </div>
    </div>

    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fas fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/2020/03/18/chang-gou-shang-cheng-shi-zhan-shi/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/9.jpg" class="responsive-img" alt="畅购商城（十）之购物车">
                        
                        <span class="card-title">畅购商城（十）之购物车</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            畅购商城-购物车实现
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="far fa-clock fa-fw icon-date"></i>2020-03-18
                        </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98/" class="post-category">
                                    项目实战
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/%E5%BE%AE%E6%9C%8D%E5%8A%A1/">
                        <span class="chip bg-color">微服务</span>
                    </a>
                    
                    <a href="/tags/SpringCloud/">
                        <span class="chip bg-color">SpringCloud</span>
                    </a>
                    
                    <a href="/tags/%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98/">
                        <span class="chip bg-color">项目实战</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2020/03/16/chang-gou-shang-cheng-shi-zhan-ba/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/6.jpg" class="responsive-img" alt="畅购商城（八）之微服务网关和Jwt令牌">
                        
                        <span class="card-title">畅购商城（八）之微服务网关和Jwt令牌</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            畅购商城-微服务网关和Jwt令牌
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2020-03-16
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98/" class="post-category">
                                    项目实战
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/%E5%BE%AE%E6%9C%8D%E5%8A%A1/">
                        <span class="chip bg-color">微服务</span>
                    </a>
                    
                    <a href="/tags/SpringCloud/">
                        <span class="chip bg-color">SpringCloud</span>
                    </a>
                    
                    <a href="/tags/%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98/">
                        <span class="chip bg-color">项目实战</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>


<script>
    $('#articleContent').on('copy', function (e) {
        // IE8 or earlier browser is 'undefined'
        if (typeof window.getSelection === 'undefined') return;

        var selection = window.getSelection();
        // if the selection is short let's not annoy our users.
        if (('' + selection).length < Number.parseInt('120')) {
            return;
        }

        // create a div outside of the visible area and fill it with the selected text.
        var bodyElement = document.getElementsByTagName('body')[0];
        var newdiv = document.createElement('div');
        newdiv.style.position = 'absolute';
        newdiv.style.left = '-99999px';
        bodyElement.appendChild(newdiv);
        newdiv.appendChild(selection.getRangeAt(0).cloneContents());

        // we need a <pre> tag workaround.
        // otherwise the text inside "pre" loses all the line breaks!
        if (selection.getRangeAt(0).commonAncestorContainer.nodeName === 'PRE') {
            newdiv.innerHTML = "<pre>" + newdiv.innerHTML + "</pre>";
        }

        var url = document.location.href;
        newdiv.innerHTML += '<br />'
            + '来源: 空白格的博客<br />'
            + '文章作者: fangpeng<br />'
            + '文章链接: <a href="' + url + '">' + url + '</a><br />'
            + '本文章著作权归作者所有，任何形式的转载都请注明出处。';

        selection.selectAllChildren(newdiv);
        window.setTimeout(function () {bodyElement.removeChild(newdiv);}, 200);
    });
</script>


<!-- 代码块功能依赖 -->
<script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script>

<!-- 代码语言 -->

<script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script>

    
<!-- 代码块复制 -->

<script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>


<!-- 代码块收缩 -->

<script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script>


<!-- 代码块折行 -->

<style type="text/css">
code[class*="language-"], pre[class*="language-"] { white-space: pre !important; }
</style>

    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget">
            <div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fas fa-list-ul"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            // headingsOffset: -205,
            headingSelector: 'h2, h3, h4'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h2, h3, h4').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>



    <footer class="page-footer bg-color">
    <div class="container row center-align">
        <div class="col s12 m8 l8 copy-right">
            Copyright&nbsp;&copy;
            <span id="year">年份</span>
            <a href="https://fangpeng12.github.io" target="_blank">fangpeng</a>
            |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a>
            |&nbsp;Theme&nbsp;<a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>
            <br>
            
            &nbsp;<i class="fas fa-chart-area"></i>&nbsp;站点总字数:&nbsp;<span
                class="white-color">694.1k</span>&nbsp;字
            
            
            
            
            
            
            <span id="busuanzi_container_site_pv">
                |&nbsp;<i class="far fa-eye"></i>&nbsp;总访问量:&nbsp;<span id="busuanzi_value_site_pv"
                    class="white-color"></span>&nbsp;次
            </span>
            
            
            <span id="busuanzi_container_site_uv">
                |&nbsp;<i class="fas fa-users"></i>&nbsp;总访问人数:&nbsp;<span id="busuanzi_value_site_uv"
                    class="white-color"></span>&nbsp;人
            </span>
            
            <br>
            
            <span id="sitetime">载入运行时间...</span>
            <script>
                function siteTime() {
                    window.setTimeout("siteTime()", 1000);
                    var seconds = 1000;
                    var minutes = seconds * 60;
                    var hours = minutes * 60;
                    var days = hours * 24;
                    var years = days * 365;
                    var today = new Date();
                    var startYear = "2019";
                    var startMonth = "12";
                    var startDate = "21";
                    var startHour = "0";
                    var startMinute = "0";
                    var startSecond = "0";
                    var todayYear = today.getFullYear();
                    var todayMonth = today.getMonth() + 1;
                    var todayDate = today.getDate();
                    var todayHour = today.getHours();
                    var todayMinute = today.getMinutes();
                    var todaySecond = today.getSeconds();
                    var t1 = Date.UTC(startYear, startMonth, startDate, startHour, startMinute, startSecond);
                    var t2 = Date.UTC(todayYear, todayMonth, todayDate, todayHour, todayMinute, todaySecond);
                    var diff = t2 - t1;
                    var diffYears = Math.floor(diff / years);
                    var diffDays = Math.floor((diff / days) - diffYears * 365);
                    var diffHours = Math.floor((diff - (diffYears * 365 + diffDays) * days) / hours);
                    var diffMinutes = Math.floor((diff - (diffYears * 365 + diffDays) * days - diffHours * hours) /
                        minutes);
                    var diffSeconds = Math.floor((diff - (diffYears * 365 + diffDays) * days - diffHours * hours -
                        diffMinutes * minutes) / seconds);
                    if (startYear == todayYear) {
                        document.getElementById("year").innerHTML = todayYear;
                        document.getElementById("sitetime").innerHTML = "本站已安全运行 " + diffDays + " 天 " + diffHours +
                            " 小时 " + diffMinutes + " 分钟 " + diffSeconds + " 秒";
                    } else {
                        document.getElementById("year").innerHTML = startYear + " - " + todayYear;
                        document.getElementById("sitetime").innerHTML = "本站已安全运行 " + diffYears + " 年 " + diffDays +
                            " 天 " + diffHours + " 小时 " + diffMinutes + " 分钟 " + diffSeconds + " 秒";
                    }
                }
                setInterval(siteTime, 1000);
            </script>
            
            <br>
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/fangpeng12" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fab fa-github"></i>
    </a>















    <a href="/atom.xml" class="tooltipped" target="_blank" data-tooltip="RSS 订阅" data-position="top" data-delay="50">
        <i class="fas fa-rss"></i>
    </a>

</div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script src="/js/search.js"></script>
<script type="text/javascript">
$(function () {
    searchFunc("/" + "search.xml", 'searchInput', 'searchResult');
});
</script>
    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    <!-- Global site tag (gtag.js) - Google Analytics -->


    <!-- Baidu Analytics -->

    <!-- Baidu Push -->

<script>
    (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>

    
    <script src="/libs/others/clicklove.js" async="async"></script>
    
    
    <script async src="/libs/others/busuanzi.pure.mini.js"></script>
    

    

    

    

    

    
    <script type="text/javascript" src="/libs/background/ribbon-dynamic.js" async="async"></script>
    
    
    
    <script src="/libs/instantpage/instantpage.js" type="module"></script>
    

</body>

</html>
