<!DOCTYPE HTML>
<html lang="zh-CN">


<head>
    <meta charset="utf-8">
    <meta name="keywords" content="畅购商城（十六）之集群高可用, 空白格的博客">
    <meta name="description" content="第16章 集群高可用学习目标
理解集群流程

理解分布式概念

能实现==Eureka集群==[集群配置]

能实现==Redis集群[Redis集群配置、哨兵策略(案例)、Redis击穿问题]==
1.Redis集群的原理
2.Redis">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>畅购商城（十六）之集群高可用 | 空白格的博客</title>
    <link rel="icon" type="image/png" href="/favicon.png">

    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/all.css">
    <link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">
    
    <script src="/libs/jquery/jquery.min.js"></script>
    
<meta name="generator" content="Hexo 4.2.0"><link rel="alternate" href="/atom.xml" title="空白格的博客" type="application/atom+xml">
<link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css"></head>


<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper head-container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">空白格的博客</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>首页</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/tags" class="waves-effect waves-light">
      
      <i class="fas fa-tags" style="zoom: 0.6;"></i>
      
      <span>标签</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/categories" class="waves-effect waves-light">
      
      <i class="fas fa-bookmark" style="zoom: 0.6;"></i>
      
      <span>分类</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/archives" class="waves-effect waves-light">
      
      <i class="fas fa-archive" style="zoom: 0.6;"></i>
      
      <span>归档</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/about" class="waves-effect waves-light">
      
      <i class="fas fa-user-circle" style="zoom: 0.6;"></i>
      
      <span>关于</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/contact" class="waves-effect waves-light">
      
      <i class="fas fa-comments" style="zoom: 0.6;"></i>
      
      <span>留言板</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/friends" class="waves-effect waves-light">
      
      <i class="fas fa-address-book" style="zoom: 0.6;"></i>
      
      <span>友情链接</span>
    </a>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="搜索" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>

<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">空白格的博客</div>
        <div class="logo-desc">
            
            个人技术博客：主要是一些技术杂谈和学习笔记的分享
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			首页
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/tags" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-tags"></i>
			
			标签
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/categories" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-bookmark"></i>
			
			分类
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/archives" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-archive"></i>
			
			归档
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/about" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-user-circle"></i>
			
			关于
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/contact" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-comments"></i>
			
			Contact
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/friends" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-address-book"></i>
			
			友情链接
		</a>
          
        </li>
        
        
        <li><div class="divider"></div></li>
        <li>
            <a href="https://github.com/fangpeng12" class="waves-effect waves-light" target="_blank">
                <i class="fab fa-github-square fa-fw"></i>Fork Me
            </a>
        </li>
        
    </ul>
</div>

        </div>

        
            <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #36b3ec;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {
        0%,
        to {
            transform: rotate(0);
        }
        20%,
        60% {
            transform: rotate(-25deg);
        }
        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="https://github.com/fangpeng12" class="github-corner tooltipped hide-on-med-and-down" target="_blank"
   data-tooltip="Fork Me" data-position="left" data-delay="50">
    <svg viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor" class="octo-body"></path>
    </svg>
</a>
        
    </nav>

</header>

    



<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/21.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <div class="description center-align post-title">
                        畅购商城（十六）之集群高可用
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        margin: 35px 0 15px 0;
        padding-left: 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #toc-content .is-active-link::before {
        background-color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 15px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/%E5%BE%AE%E6%9C%8D%E5%8A%A1/">
                                <span class="chip bg-color">微服务</span>
                            </a>
                        
                            <a href="/tags/SpringCloud/">
                                <span class="chip bg-color">SpringCloud</span>
                            </a>
                        
                            <a href="/tags/%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98/">
                                <span class="chip bg-color">项目实战</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fas fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98/" class="post-category">
                                项目实战
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2020-03-26
                </div>
                

                

                
                <div class="info-break-policy">
                    <i class="far fa-file-word fa-fw"></i>文章字数:&nbsp;&nbsp;
                    9.2k
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-clock fa-fw"></i>阅读时长:&nbsp;&nbsp;
                    39 分
                </div>
                
				
                
                    <div id="busuanzi_container_page_pv" class="info-break-policy">
                        <i class="far fa-eye fa-fw"></i>阅读次数:&nbsp;&nbsp;
                        <span id="busuanzi_value_page_pv"></span>
                    </div>
				
            </div>
            
        </div>
        <hr class="clearfix">
        <div class="card-content article-card-content">
            <div id="articleContent">
                <h1 id="第16章-集群高可用"><a href="#第16章-集群高可用" class="headerlink" title="第16章 集群高可用"></a>第16章 集群高可用</h1><h2 id="学习目标"><a href="#学习目标" class="headerlink" title="学习目标"></a>学习目标</h2><ul>
<li><p>理解集群流程</p>
</li>
<li><p>理解分布式概念</p>
</li>
<li><p>能实现==Eureka集群==[集群配置]</p>
</li>
<li><p>能实现==Redis集群[Redis集群配置、哨兵策略(案例)、Redis击穿问题]==</p>
<pre><code>1.Redis集群的原理
2.Redis集群会用-&gt;在java代码中能链接集群服务
3.哨兵策略-&gt;监控集群的健康状态[作用]
4.Redis击穿-&gt;如何解决击穿问题
5.如何解决Redis雪崩问题-&gt;多级缓存</code></pre></li>
<li><p>RabbitMQ集群</p>
</li>
</ul>
<h2 id="1-集群概述"><a href="#1-集群概述" class="headerlink" title="1.集群概述"></a>1.集群概述</h2><h3 id="1-1什么是集群"><a href="#1-1什么是集群" class="headerlink" title="1.1什么是集群"></a>1.1什么是集群</h3><h4 id="1-1-1集群概念"><a href="#1-1-1集群概念" class="headerlink" title="1.1.1集群概念"></a>1.1.1集群概念</h4><p>集群是一种计算机系统， 它通过一组松散集成的计算机软件和/或硬件连接起来高度紧密地协作完成计算工作。在某种意义上，他们可以被看作是一台计算机。集群系统中的单个计算机通常称为节点，通常通过局域网连接，但也有其它的可能连接方式。集群计算机通常用来改进单个计算机的计算速度和/或可靠性。一般情况下集群计算机比单个计算机，比如工作站或超级计算机性能价格比要高得多。</p>
<h4 id="1-1-2集群的特点"><a href="#1-1-2集群的特点" class="headerlink" title="1.1.2集群的特点"></a>1.1.2集群的特点</h4><p>集群拥有以下两个特点：</p>
<ol>
<li>可扩展性：集群的性能不限制于单一的服务实体，新的服务实体可以动态的添加到集群，从而增强集群的性能。</li>
<li>高可用性：集群当其中一个节点发生故障时，这台节点上面所运行的应用程序将在另一台节点被自动接管，消除单点故障对于增强数据可用性、可达性和可靠性是非常重要的。</li>
</ol>
<h4 id="1-1-3集群的两大能力"><a href="#1-1-3集群的两大能力" class="headerlink" title="1.1.3集群的两大能力"></a>1.1.3集群的两大能力</h4><p>集群必须拥有以下两大能力：</p>
<ol>
<li>负载均衡：负载均衡把任务比较均匀的分布到集群环境下的计算和网络资源，以提高数据吞吐量。</li>
<li>错误恢复：如果集群中的某一台服务器由于故障或者维护需要无法使用，资源和应用程序将转移到可用的集群节点上。这种由于某个节点的资源不能工作，另一个可用节点中的资源能够透明的接管并继续完成任务的过程，叫做错误恢复。</li>
</ol>
<p>负载均衡和错误恢复要求各服务实体中有执行同一任务的资源存在，而且对于同一任务的各个资源来说，执行任务所需的信息视图必须是相同的。</p>
<h3 id="1-2集群与分布式的区别"><a href="#1-2集群与分布式的区别" class="headerlink" title="1.2集群与分布式的区别"></a>1.2集群与分布式的区别</h3><p>说到集群，可能大家会立刻联想到另一个和它很相近的一个词—-“分布式”。那么集群和分布式是一回事吗？有什么联系和区别呢?</p>
<p>相同点：</p>
<p>分布式和集群都是需要有很多节点服务器通过网络协同工作完成整体的任务目标。</p>
<p>不同点：</p>
<p>分布式是指将业务系统进行拆分，即分布式的每一个节点都是实现不同的功能。而集群每个节点做的是同一件事情。</p>
<p>如下图，每个人都有不同的分工，一起协作干一件事，叫做“分布式”</p>
<p><img src="/2020/03/26/chang-gou-shang-cheng-shi-zhan-shi-liu/1553819130753.png" alt></p>
<p>再看下图：每个划桨人干的都是一样的活，叫做集群。</p>
<p><img src="/2020/03/26/chang-gou-shang-cheng-shi-zhan-shi-liu/1553999551061.png" alt></p>
<p>分布式的每一个节点也可以做成集群。其实这个赛龙舟的图，总整体来看属于分布式,包括打鼓和划桨两个分布式节点，而划桨的节点又是集群的形态。</p>
<h2 id="2-Eureka集群"><a href="#2-Eureka集群" class="headerlink" title="2 Eureka集群"></a>2 Eureka集群</h2><h3 id="2-1-Eureka简介"><a href="#2-1-Eureka简介" class="headerlink" title="2.1 Eureka简介"></a>2.1 Eureka简介</h3><h4 id="2-1-1什么是Eureka"><a href="#2-1-1什么是Eureka" class="headerlink" title="2.1.1什么是Eureka"></a>2.1.1什么是Eureka</h4><p>​    Eureka是一种基于REST（Representational State Transfer）的服务，主要用于AWS，用于定位服务，以实现中间层服务器的负载平衡和故障转移。我们将此服务称为Eureka Server。Eureka还附带了一个基于Java的客户端组件Eureka Client，它使与服务的交互变得更加容易。客户端还有一个内置的负载均衡器，可以进行基本的循环负载均衡。在Netflix，一个更复杂的负载均衡器包装Eureka，根据流量，资源使用，错误条件等多种因素提供加权负载平衡，以提供卓越的弹性。</p>
<p>理解：</p>
<p>​    Eureka是一个服务注册与发现的注册中心。类似于dubbo中的zookeeper.</p>
<p>官网地址：</p>
<p>​         <a href="https://github.com/Netflix/eureka/wiki/Eureka-at-a-glance" target="_blank" rel="noopener">https://github.com/Netflix/eureka/wiki/Eureka-at-a-glance</a></p>
<h5 id="2-1-2Eureka的架构"><a href="#2-1-2Eureka的架构" class="headerlink" title="2.1.2Eureka的架构"></a>2.1.2Eureka的架构</h5><p><img src="/2020/03/26/chang-gou-shang-cheng-shi-zhan-shi-liu/1558513888400.png" alt></p>
<p>application Service :相当于服务提供者</p>
<p>application Client :相当于服务消费者</p>
<p>make remote call :服务调用过程</p>
<p>us-east-1c d e 都是region:us-east-1 的可用区域。</p>
<p>简单可以理解为：</p>
<p>​     每一个erurak都是一个节点，默认启动时就是以集群的方式。</p>
<p>区别：</p>
<pre><code>erurak:集群，各个节点的数据一致，各个节点都属于同等级别的注册中心，不存在leader的概念。
zookeeper：Zookeeper集群存在Leader节点，并且会进行Leader选举，Leader具有最高权限。</code></pre><h3 id="2-2-搭建Eureka集群"><a href="#2-2-搭建Eureka集群" class="headerlink" title="2.2 搭建Eureka集群"></a>2.2 搭建Eureka集群</h3><p>配置host文件<code>C:\Windows\System32\drivers\etc\hosts</code>文件，添加映射</p>
<pre><code>127.0.0.1 eureka-server1
127.0.0.1 eureka-server2
127.0.0.1 eureka-server3</code></pre><h4 id="2-2-1-application-yml配置"><a href="#2-2-1-application-yml配置" class="headerlink" title="2.2.1 application.yml配置"></a>2.2.1 application.yml配置</h4><p>第1台application.yml:</p>
<pre class=" language-properties"><code class="language-properties"><span class="token attr-name">server</span><span class="token punctuation">:</span>
<span class="token attr-name">  port</span><span class="token punctuation">:</span> <span class="token attr-value">8761</span>
<span class="token attr-name">eureka</span><span class="token punctuation">:</span>
<span class="token attr-name">  instance</span><span class="token punctuation">:</span>
<span class="token attr-name">    hostname</span><span class="token punctuation">:</span> <span class="token attr-value">eureka-server1</span>
<span class="token attr-name">  client</span><span class="token punctuation">:</span>
<span class="token attr-name">    register-with-eureka</span><span class="token punctuation">:</span> <span class="token attr-value">false</span>
<span class="token attr-name">    fetch-registry</span><span class="token punctuation">:</span> <span class="token attr-value">false</span>
<span class="token attr-name">    service-url</span><span class="token punctuation">:</span>
<span class="token attr-name">      defaultZone</span><span class="token punctuation">:</span> <span class="token attr-value">http://eureka-server2:8762/eureka/,http://eureka-server3:8763/eureka/</span></code></pre>
<p>第2台application.yml</p>
<pre class=" language-properties"><code class="language-properties"><span class="token attr-name">server</span><span class="token punctuation">:</span>
<span class="token attr-name">  port</span><span class="token punctuation">:</span> <span class="token attr-value">8762</span>
<span class="token attr-name">eureka</span><span class="token punctuation">:</span>
<span class="token attr-name">  instance</span><span class="token punctuation">:</span>
<span class="token attr-name">    hostname</span><span class="token punctuation">:</span> <span class="token attr-value">eureka-server2</span>
<span class="token attr-name">  client</span><span class="token punctuation">:</span>
<span class="token attr-name">    register-with-eureka</span><span class="token punctuation">:</span> <span class="token attr-value">false</span>
<span class="token attr-name">    fetch-registry</span><span class="token punctuation">:</span> <span class="token attr-value">false</span>
<span class="token attr-name">    service-url</span><span class="token punctuation">:</span>
<span class="token attr-name">      defaultZone</span><span class="token punctuation">:</span> <span class="token attr-value">http://eureka-server1:8761/eureka/,http://eureka-server3:8763/eureka/</span></code></pre>
<p>第3台application.yml配置：</p>
<pre class=" language-properties"><code class="language-properties"><span class="token attr-name">server</span><span class="token punctuation">:</span>
<span class="token attr-name">  port</span><span class="token punctuation">:</span> <span class="token attr-value">8763</span>
<span class="token attr-name">eureka</span><span class="token punctuation">:</span>
<span class="token attr-name">  instance</span><span class="token punctuation">:</span>
<span class="token attr-name">    hostname</span><span class="token punctuation">:</span> <span class="token attr-value">eureka-server3</span>
<span class="token attr-name">  client</span><span class="token punctuation">:</span>
<span class="token attr-name">    register-with-eureka</span><span class="token punctuation">:</span> <span class="token attr-value">false</span>
<span class="token attr-name">    fetch-registry</span><span class="token punctuation">:</span> <span class="token attr-value">false</span>
<span class="token attr-name">    service-url</span><span class="token punctuation">:</span>
<span class="token attr-name">      defaultZone</span><span class="token punctuation">:</span> <span class="token attr-value">http://eureka-server1:8761/eureka/,http://eureka-server2:8762/eureka/</span></code></pre>
<h4 id="2-2-2-效果"><a href="#2-2-2-效果" class="headerlink" title="2.2.2 效果"></a>2.2.2 效果</h4><p><a href="http://localhost:8761/" target="_blank" rel="noopener">http://localhost:8761/</a></p>
<p><img src="/2020/03/26/chang-gou-shang-cheng-shi-zhan-shi-liu/1565935274654.png" alt></p>
<p><a href="http://localhost:8762/" target="_blank" rel="noopener">http://localhost:8762/</a></p>
<p><img src="/2020/03/26/chang-gou-shang-cheng-shi-zhan-shi-liu/1565935327414.png" alt></p>
<p><a href="http://localhost:8763/" target="_blank" rel="noopener">http://localhost:8763/</a></p>
<p><img src="/2020/03/26/chang-gou-shang-cheng-shi-zhan-shi-liu/1565935358314.png" alt></p>
<p>项目中使用的时候，将多个写到一起，隔开即可，代码如下：</p>
<pre class=" language-properties"><code class="language-properties"><span class="token attr-name">eureka</span><span class="token punctuation">:</span>
<span class="token attr-name">  client</span><span class="token punctuation">:</span>
<span class="token attr-name">    service-url</span><span class="token punctuation">:</span>
<span class="token attr-name">      defaultZone</span><span class="token punctuation">:</span> <span class="token attr-value">http://eureka-server1:8761/eureka/,http://eureka-server2:8761/eureka/,http://eureka-server3:8763/eureka/</span></code></pre>
<h2 id="3-Redis-Cluster"><a href="#3-Redis-Cluster" class="headerlink" title="3 Redis Cluster"></a>3 Redis Cluster</h2><h3 id="4-1-Redis-Cluster简介"><a href="#4-1-Redis-Cluster简介" class="headerlink" title="4.1 Redis-Cluster简介"></a>4.1 Redis-Cluster简介</h3><h4 id="4-1-1-什么是Redis-Cluster"><a href="#4-1-1-什么是Redis-Cluster" class="headerlink" title="4.1.1 什么是Redis-Cluster"></a>4.1.1 什么是Redis-Cluster</h4><p>为何要搭建Redis集群。Redis是在内存中保存数据的，而我们的电脑一般内存都不大，这也就意味着Redis不适合存储大数据，适合存储大数据的是Hadoop生态系统的Hbase或者是MogoDB。Redis更适合处理高并发，一台设备的存储能力是很有限的，但是多台设备协同合作，就可以让内存增大很多倍，这就需要用到集群。</p>
<p>Redis集群搭建的方式有多种，例如使用客户端分片、Twemproxy、Codis等，但从redis 3.0之后版本支持redis-cluster集群，它是Redis官方提出的解决方案，Redis-Cluster采用无中心结构，每个节点保存数据和整个集群状态,每个节点都和其他所有节点连接。其redis-cluster架构图如下：</p>
<p><img src="/2020/03/26/chang-gou-shang-cheng-shi-zhan-shi-liu/1554000037613.png" alt></p>
<p>客户端与 redis 节点直连,不需要中间 proxy 层.客户端不需要连接集群所有节点连接集群中任何一个可用节点即可。</p>
<p>所有的 redis 节点彼此互联(PING-PONG 机制),内部使用二进制协议优化传输速度和带宽.</p>
<h5 id="4-1-2分布存储机制-槽"><a href="#4-1-2分布存储机制-槽" class="headerlink" title="4.1.2分布存储机制-槽"></a>4.1.2分布存储机制-槽</h5><p>（1）redis-cluster 把所有的物理节点映射到[0-16383]slot 上,cluster 负责维护</p>
<p>node&lt;-&gt;slot&lt;-&gt;value</p>
<p>（2）Redis 集群中内置了 16384 个哈希槽，当需要在 Redis 集群中放置一个 key-value 时，redis 先对 key 使用 crc16 算法算出一个结果，然后把结果对 16384 求余数，这样每个key 都会对应一个编号在 0-16383 之间的哈希槽，redis 会根据节点数量大致均等的将哈希槽映射到不同的节点。</p>
<p>​    例如三个节点：槽分布的值如下：</p>
<p>SERVER1:  0-5460</p>
<p>SERVER2:  5461-10922</p>
<p>SERVER3:  10923-16383</p>
<h5 id="4-1-3容错机制-投票"><a href="#4-1-3容错机制-投票" class="headerlink" title="4.1.3容错机制-投票"></a>4.1.3容错机制-投票</h5><p>（1）选举过程是集群中所有master参与,如果半数以上master节点与故障节点通信超过(cluster-node-timeout),认为该节点故障，自动触发故障转移操作.  故障节点对应的从节点自动升级为主节点</p>
<p>（2）什么时候整个集群不可用(cluster_state:fail)? </p>
<p>如果集群任意master挂掉,且当前master没有slave.集群进入fail状态,也可以理解成集群的slot映射[0-16383]不完成时进入fail状态. </p>
<p><img src="/2020/03/26/chang-gou-shang-cheng-shi-zhan-shi-liu/1554000104675.png" alt></p>
<h4 id="4-2搭建Redis-Cluster"><a href="#4-2搭建Redis-Cluster" class="headerlink" title="4.2搭建Redis-Cluster"></a>4.2搭建Redis-Cluster</h4><h5 id="4-2-1搭建要求"><a href="#4-2-1搭建要求" class="headerlink" title="4.2.1搭建要求"></a>4.2.1搭建要求</h5><p>需要 6 台 redis 服务器。搭建伪集群。</p>
<p>需要 6 个 redis 实例。</p>
<p>需要运行在不同的端口 7001-7006</p>
<h5 id="4-2-2准备工作"><a href="#4-2-2准备工作" class="headerlink" title="4.2.2准备工作"></a>4.2.2准备工作</h5><p>（1）安装gcc 【此步省略】</p>
<p>Redis 是 c 语言开发的。安装 redis 需要 c 语言的编译环境。如果没有 gcc 需要在线安装。</p>
<pre><code>yum install gcc-c++</code></pre><p>（2）使用yum命令安装 ruby  （我们需要使用ruby脚本来实现集群搭建）【此步省略】</p>
<pre><code>yum install ruby
yum install rubygems</code></pre><pre><code>----- 知识点小贴士 -----
Ruby，一种简单快捷的面向对象（面向对象程序设计）脚本语言，在20世纪90年代由日本人松本行弘(Yukihiro Matsumoto)开发，遵守GPL协议和Ruby License。它的灵感与特性来自于 Perl、Smalltalk、Eiffel、Ada以及 Lisp 语言。由 Ruby 语言本身还发展出了JRuby（Java平台）、IronRuby（.NET平台）等其他平台的 Ruby 语言替代品。Ruby的作者于1993年2月24日开始编写Ruby，直至1995年12月才正式公开发布于fj（新闻组）。因为Perl发音与6月诞生石pearl（珍珠）相同，因此Ruby以7月诞生石ruby（红宝石）命名
RubyGems简称gems，是一个用于对 Ruby组件进行打包的 Ruby 打包系统</code></pre><p>（3）将redis源码包上传到 linux 系统  ，解压redis源码包</p>
<p>（4）编译redis源码  ，进入redis源码文件夹</p>
<pre><code>make</code></pre><p>看到以下输出结果，表示编译成功</p>
<p><img src="/2020/03/26/chang-gou-shang-cheng-shi-zhan-shi-liu/1554000161720.png" alt></p>
<p>（5）创建目录/usr/local/redis-cluster目录，  安装6个redis实例，分别安装在以下目录</p>
<pre class=" language-properties"><code class="language-properties">/usr/local/redis-cluster/redis-1
/usr/local/redis-cluster/redis-2
/usr/local/redis-cluster/redis-3
/usr/local/redis-cluster/redis-4
/usr/local/redis-cluster/redis-5
/usr/local/redis-cluster/redis-6</code></pre>
<p>以第一个redis实例为例，命令如下</p>
<pre><code>make install PREFIX=/usr/local/redis-cluster/redis-1</code></pre><p><img src="/2020/03/26/chang-gou-shang-cheng-shi-zhan-shi-liu/1554000236118.png" alt></p>
<p>出现此提示表示成功，按此方法安装其余5个redis实例</p>
<p>（6）复制配置文件  将 /redis-3.0.0/redis.conf 复制到redis下的bin目录下</p>
<pre class=" language-properties"><code class="language-properties"><span class="token attr-name">[root@localhost</span> <span class="token attr-value">redis-3.0.0]# cp redis.conf /usr/local/redis-cluster/redis-1/bin</span>
<span class="token attr-name">[root@localhost</span> <span class="token attr-value">redis-3.0.0]# cp redis.conf /usr/local/redis-cluster/redis-2/bin</span>
<span class="token attr-name">[root@localhost</span> <span class="token attr-value">redis-3.0.0]# cp redis.conf /usr/local/redis-cluster/redis-3/bin</span>
<span class="token attr-name">[root@localhost</span> <span class="token attr-value">redis-3.0.0]# cp redis.conf /usr/local/redis-cluster/redis-4/bin</span>
<span class="token attr-name">[root@localhost</span> <span class="token attr-value">redis-3.0.0]# cp redis.conf /usr/local/redis-cluster/redis-5/bin</span>
<span class="token attr-name">[root@localhost</span> <span class="token attr-value">redis-3.0.0]# cp redis.conf /usr/local/redis-cluster/redis-6/bin</span></code></pre>
<h5 id="4-2-3配置集群"><a href="#4-2-3配置集群" class="headerlink" title="4.2.3配置集群"></a>4.2.3配置集群</h5><p>（1）修改每个redis节点的配置文件redis.conf</p>
<p>​      修改运行端口为7001 （7002 7003 …..）</p>
<p>​      将cluster-enabled yes 前的注释去掉(632行)</p>
<p><img src="/2020/03/26/chang-gou-shang-cheng-shi-zhan-shi-liu/1554000285785.png" alt></p>
<p>集群：</p>
<pre><code>6个节点
3主
3从

1)创建6个节点  7001-7006
2)开启集群
3)串联集群[将集群链接到一起]</code></pre><p>（2）启动每个redis实例</p>
<p>​    以第一个实例为例，命令如下</p>
<pre class=" language-properties"><code class="language-properties"><span class="token attr-name">cd</span> <span class="token attr-value">/usr/local/redis-cluster/redis-1/bin/</span>
<span class="token attr-name">./redis-server</span> <span class="token attr-value">redis.conf</span></code></pre>
<p><img src="/2020/03/26/chang-gou-shang-cheng-shi-zhan-shi-liu/1554000368400.png" alt></p>
<p>把其余的5个也启动起来，然后查看一下是不是都启动起来了</p>
<pre class=" language-properties"><code class="language-properties"><span class="token attr-name">[root@localhost</span> <span class="token attr-value">~]# ps -ef | grep redis</span>
<span class="token attr-name">root</span> <span class="token attr-value">    15776 15775  0 08:19 pts/1    00:00:00 ./redis-server *:7001 [cluster]</span>
<span class="token attr-name">root</span> <span class="token attr-value">    15810 15784  0 08:22 pts/2    00:00:00 ./redis-server *:7002 [cluster]</span>
<span class="token attr-name">root</span> <span class="token attr-value">    15831 15813  0 08:23 pts/3    00:00:00 ./redis-server *:7003 [cluster]</span>
<span class="token attr-name">root</span> <span class="token attr-value">    15852 15834  0 08:23 pts/4    00:00:00 ./redis-server *:7004 [cluster]</span>
<span class="token attr-name">root</span> <span class="token attr-value">    15872 15856  0 08:24 pts/5    00:00:00 ./redis-server *:7005 [cluster]</span>
<span class="token attr-name">root</span> <span class="token attr-value">    15891 15875  0 08:24 pts/6    00:00:00 ./redis-server *:7006 [cluster]</span>
<span class="token attr-name">root</span> <span class="token attr-value">    15926 15895  0 08:24 pts/7    00:00:00 grep redis</span></code></pre>
<p>（3）上传redis-3.0.0.gem ，安装 ruby用于搭建redis集群的脚本。</p>
<pre class=" language-properties"><code class="language-properties"><span class="token attr-name">[root@localhost</span> <span class="token attr-value">~]# gem install redis-3.0.0.gem</span>
<span class="token attr-name">Successfully</span> <span class="token attr-value">installed redis-3.0.0</span>
<span class="token attr-name">1</span> <span class="token attr-value">gem installed</span>
<span class="token attr-name">Installing</span> <span class="token attr-value">ri documentation for redis-3.0.0...</span>
<span class="token attr-name">Installing</span> <span class="token attr-value">RDoc documentation for redis-3.0.0...</span></code></pre>
<p>（4）使用 ruby 脚本搭建集群。</p>
<p>进入redis源码目录中的src目录  执行下面的命令  <code>redis-trib.rb</code> ruby工具,可以实现Redis集群,<code>create</code>创建集群，<code>--replicas</code>创建主从关系 1：是否随机创建（是）。</p>
<pre class=" language-properties"><code class="language-properties"><span class="token attr-name">./redis-trib.rb</span> <span class="token attr-value">create --replicas 1 192.168.25.140:7001 192.168.25.140:7002 192.168.25.140:7003</span>
<span class="token attr-name">192.168.25.140</span><span class="token punctuation">:</span><span class="token attr-value">7004 192.168.25.140:7005 192.168.25.140:7006</span></code></pre>
<p>出现下列提示信息</p>
<pre class=" language-properties"><code class="language-properties"><span class="token attr-name">>>></span> <span class="token attr-value">Creating cluster</span>
<span class="token attr-name">Connecting</span> <span class="token attr-value">to node 192.168.25.140:7001: OK</span>
<span class="token attr-name">Connecting</span> <span class="token attr-value">to node 192.168.25.140:7002: OK</span>
<span class="token attr-name">Connecting</span> <span class="token attr-value">to node 192.168.25.140:7003: OK</span>
<span class="token attr-name">Connecting</span> <span class="token attr-value">to node 192.168.25.140:7004: OK</span>
<span class="token attr-name">Connecting</span> <span class="token attr-value">to node 192.168.25.140:7005: OK</span>
<span class="token attr-name">Connecting</span> <span class="token attr-value">to node 192.168.25.140:7006: OK</span>
<span class="token attr-name">>>></span> <span class="token attr-value">Performing hash slots allocation on 6 nodes...</span>
<span class="token attr-name">Using</span> <span class="token attr-value">3 masters:</span>
<span class="token attr-name">192.168.25.140</span><span class="token punctuation">:</span><span class="token attr-value">7001</span>
<span class="token attr-name">192.168.25.140</span><span class="token punctuation">:</span><span class="token attr-value">7002</span>
<span class="token attr-name">192.168.25.140</span><span class="token punctuation">:</span><span class="token attr-value">7003</span>
<span class="token attr-name">Adding</span> <span class="token attr-value">replica 192.168.25.140:7004 to 192.168.25.140:7001</span>
<span class="token attr-name">Adding</span> <span class="token attr-value">replica 192.168.25.140:7005 to 192.168.25.140:7002</span>
<span class="token attr-name">Adding</span> <span class="token attr-value">replica 192.168.25.140:7006 to 192.168.25.140:7003</span>
<span class="token attr-name">M</span><span class="token punctuation">:</span> <span class="token attr-value">1800237a743c2aa918ade045a28128448c6ce689 192.168.25.140:7001</span>
<span class="token attr-name">   slots</span><span class="token punctuation">:</span><span class="token attr-value">0-5460 (5461 slots) master</span>
<span class="token attr-name">M</span><span class="token punctuation">:</span> <span class="token attr-value">7cb3f7d5c60bfbd3ab28800f8fd3bf6de005bf0d 192.168.25.140:7002</span>
<span class="token attr-name">   slots</span><span class="token punctuation">:</span><span class="token attr-value">5461-10922 (5462 slots) master</span>
<span class="token attr-name">M</span><span class="token punctuation">:</span> <span class="token attr-value">436e88ec323a2f8bb08bf09f7df07cc7909fcf81 192.168.25.140:7003</span>
<span class="token attr-name">   slots</span><span class="token punctuation">:</span><span class="token attr-value">10923-16383 (5461 slots) master</span>
<span class="token attr-name">S</span><span class="token punctuation">:</span> <span class="token attr-value">c2a39a94b5f41532cd83bf6643e98fc277c2f441 192.168.25.140:7004</span>
<span class="token attr-name">   replicates</span> <span class="token attr-value">1800237a743c2aa918ade045a28128448c6ce689</span>
<span class="token attr-name">S</span><span class="token punctuation">:</span> <span class="token attr-value">b0e38d80273515c84b1a01820d8ecee04547d776 192.168.25.140:7005</span>
<span class="token attr-name">   replicates</span> <span class="token attr-value">7cb3f7d5c60bfbd3ab28800f8fd3bf6de005bf0d</span>
<span class="token attr-name">S</span><span class="token punctuation">:</span> <span class="token attr-value">03bf6bd7e3e6eece5a02043224497c2c8e185132 192.168.25.140:7006</span>
<span class="token attr-name">   replicates</span> <span class="token attr-value">436e88ec323a2f8bb08bf09f7df07cc7909fcf81</span>
<span class="token attr-name">Can</span> <span class="token attr-value">I set the above configuration? (type 'yes' to accept): yes</span>
<span class="token attr-name">>>></span> <span class="token attr-value">Nodes configuration updated</span>
<span class="token attr-name">>>></span> <span class="token attr-value">Assign a different config epoch to each node</span>
<span class="token attr-name">>>></span> <span class="token attr-value">Sending CLUSTER MEET messages to join the cluster</span>
<span class="token attr-name">Waiting</span> <span class="token attr-value">for the cluster to join....</span>
<span class="token attr-name">>>></span> <span class="token attr-value">Performing Cluster Check (using node 192.168.25.140:7001)</span>
<span class="token attr-name">M</span><span class="token punctuation">:</span> <span class="token attr-value">1800237a743c2aa918ade045a28128448c6ce689 192.168.25.140:7001</span>
<span class="token attr-name">   slots</span><span class="token punctuation">:</span><span class="token attr-value">0-5460 (5461 slots) master</span>
<span class="token attr-name">M</span><span class="token punctuation">:</span> <span class="token attr-value">7cb3f7d5c60bfbd3ab28800f8fd3bf6de005bf0d 192.168.25.140:7002</span>
<span class="token attr-name">   slots</span><span class="token punctuation">:</span><span class="token attr-value">5461-10922 (5462 slots) master</span>
<span class="token attr-name">M</span><span class="token punctuation">:</span> <span class="token attr-value">436e88ec323a2f8bb08bf09f7df07cc7909fcf81 192.168.25.140:7003</span>
<span class="token attr-name">   slots</span><span class="token punctuation">:</span><span class="token attr-value">10923-16383 (5461 slots) master</span>
<span class="token attr-name">M</span><span class="token punctuation">:</span> <span class="token attr-value">c2a39a94b5f41532cd83bf6643e98fc277c2f441 192.168.25.140:7004</span>
<span class="token attr-name">   slots</span><span class="token punctuation">:</span> <span class="token attr-value">(0 slots) master</span>
<span class="token attr-name">   replicates</span> <span class="token attr-value">1800237a743c2aa918ade045a28128448c6ce689</span>
<span class="token attr-name">M</span><span class="token punctuation">:</span> <span class="token attr-value">b0e38d80273515c84b1a01820d8ecee04547d776 192.168.25.140:7005</span>
<span class="token attr-name">   slots</span><span class="token punctuation">:</span> <span class="token attr-value">(0 slots) master</span>
<span class="token attr-name">   replicates</span> <span class="token attr-value">7cb3f7d5c60bfbd3ab28800f8fd3bf6de005bf0d</span>
<span class="token attr-name">M</span><span class="token punctuation">:</span> <span class="token attr-value">03bf6bd7e3e6eece5a02043224497c2c8e185132 192.168.25.140:7006</span>
<span class="token attr-name">   slots</span><span class="token punctuation">:</span> <span class="token attr-value">(0 slots) master</span>
<span class="token attr-name">   replicates</span> <span class="token attr-value">436e88ec323a2f8bb08bf09f7df07cc7909fcf81</span>
<span class="token attr-name">[OK]</span> <span class="token attr-value">All nodes agree about slots configuration.</span>
<span class="token attr-name">>>></span> <span class="token attr-value">Check for open slots...</span>
<span class="token attr-name">>>></span> <span class="token attr-value">Check slots coverage...</span>
<span class="token attr-name">[OK]</span> <span class="token attr-value">All 16384 slots covered.</span></code></pre>
<h4 id="4-3连接Redis-Cluster"><a href="#4-3连接Redis-Cluster" class="headerlink" title="4.3连接Redis-Cluster"></a>4.3连接Redis-Cluster</h4><h5 id="4-3-1客户端工具连接"><a href="#4-3-1客户端工具连接" class="headerlink" title="4.3.1客户端工具连接"></a>4.3.1客户端工具连接</h5><p>Redis-cli 连接集群：</p>
<pre><code>redis-cli -p ip地址 -p 端口 -c</code></pre><p>-c：代表连接的是 redis 集群</p>
<p>测试值的存取:</p>
<p>（1）从本地连接到集群redis  使用7001端口 加 -c 参数</p>
<p>（2）存入name值为abc ，系统提示此值被存入到了7002端口所在的redis （槽是5798）</p>
<p>（3）提取name的值，可以提取。</p>
<p>（4）退出（quit）</p>
<p>（5）再次以7001端口进入 ，不带-c</p>
<p>（6）查询name值，无法获取，因为值在7002端口的redis上</p>
<p>（7）我们以7002端口进入，获取name值发现是可以获取的,而以其它端口进入均不能获取</p>
<h5 id="4-3-2-springboot连接redis集群"><a href="#4-3-2-springboot连接redis集群" class="headerlink" title="4.3.2 springboot连接redis集群"></a>4.3.2 springboot连接redis集群</h5><p>（1）创建工程 ，打包方式jar包，命名为：changgou-redis-demo</p>
<p>（2）添加redis起步依赖</p>
<pre class=" language-xml"><code class="language-xml"><span class="token prolog">&lt;?xml version="1.0" encoding="UTF-8"?></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>project</span> <span class="token attr-name">xmlns</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>http://maven.apache.org/POM/4.0.0<span class="token punctuation">"</span></span> <span class="token attr-name"><span class="token namespace">xmlns:</span>xsi</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>http://www.w3.org/2001/XMLSchema-instance<span class="token punctuation">"</span></span>
   <span class="token attr-name"><span class="token namespace">xsi:</span>schemaLocation</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>modelVersion</span><span class="token punctuation">></span></span>4.0.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>modelVersion</span><span class="token punctuation">></span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>parent</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-boot-starter-parent<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>2.1.4.RELEASE<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>relativePath</span><span class="token punctuation">/></span></span> <span class="token comment" spellcheck="true">&lt;!-- lookup parent from repository --></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>parent</span><span class="token punctuation">></span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>com.itheima<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>changgou-redis-demo<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>0.0.1-SNAPSHOT<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">></span></span>changgou-redis-demo<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">></span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>description</span><span class="token punctuation">></span></span>redis<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>description</span><span class="token punctuation">></span></span>

   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>properties</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>java.version</span><span class="token punctuation">></span></span>1.8<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>java.version</span><span class="token punctuation">></span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>properties</span><span class="token punctuation">></span></span>

   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
         <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
         <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-boot-starter-data-redis<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
         <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
         <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-boot-starter-web<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
         <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.mybatis.spring.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
         <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>mybatis-spring-boot-starter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
         <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>2.0.1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>

      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
         <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>mysql<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
         <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>mysql-connector-java<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
         <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">></span></span>runtime<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
         <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
         <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-boot-starter-test<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
         <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">></span></span>test<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>


   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">></span></span>

   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>build</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugins</span><span class="token punctuation">></span></span>
         <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugin</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-boot-maven-plugin<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
         <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugin</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugins</span><span class="token punctuation">></span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>build</span><span class="token punctuation">></span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>project</span><span class="token punctuation">></span></span></code></pre>
<p>（3）配置application.yml</p>
<pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">datasource</span><span class="token punctuation">:</span>
    <span class="token key atrule">driver-class-name</span><span class="token punctuation">:</span> com.mysql.jdbc.Driver
    <span class="token key atrule">url</span><span class="token punctuation">:</span> jdbc<span class="token punctuation">:</span>mysql<span class="token punctuation">:</span>//127.0.0.1<span class="token punctuation">:</span>3306/changgou_user<span class="token punctuation">?</span>useUnicode=true<span class="token important">&amp;characterEncoding</span>=UTF<span class="token punctuation">-</span>8<span class="token important">&amp;serverTimezone</span>=UTC
    <span class="token key atrule">username</span><span class="token punctuation">:</span> root
    <span class="token key atrule">password</span><span class="token punctuation">:</span> itcast
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> redis<span class="token punctuation">-</span>demo
    <span class="token comment" spellcheck="true">#redis配置</span>

<span class="token comment" spellcheck="true">#  rabbitmq:</span>
<span class="token comment" spellcheck="true">#    addresses: 192.168.25.130:5672,192.168.25.134:5672</span>
<span class="token comment" spellcheck="true">#    username: guest</span>
<span class="token comment" spellcheck="true">#    password: guest</span>
  <span class="token key atrule">redis</span><span class="token punctuation">:</span>
    <span class="token key atrule">cluster</span><span class="token punctuation">:</span>
      <span class="token key atrule">nodes</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> 192.168.25.153<span class="token punctuation">:</span><span class="token number">7001</span>
      <span class="token punctuation">-</span> 192.168.25.153<span class="token punctuation">:</span><span class="token number">7002</span>
      <span class="token punctuation">-</span> 192.168.25.153<span class="token punctuation">:</span><span class="token number">7003</span>
      <span class="token punctuation">-</span> 192.168.25.153<span class="token punctuation">:</span><span class="token number">7004</span>
      <span class="token punctuation">-</span> 192.168.25.153<span class="token punctuation">:</span><span class="token number">7005</span>
      <span class="token punctuation">-</span> 192.168.25.153<span class="token punctuation">:</span><span class="token number">7006</span>
<span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">ssl</span><span class="token punctuation">:</span>
    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">9008</span>
<span class="token key atrule">mybatis</span><span class="token punctuation">:</span>
  <span class="token key atrule">configuration</span><span class="token punctuation">:</span>
    <span class="token key atrule">map-underscore-to-camel-case</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></code></pre>
<p>（4）创建测试类进行测试：</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>itheima<span class="token punctuation">.</span>changgouredisdemo<span class="token punctuation">;</span>

<span class="token keyword">import</span> org<span class="token punctuation">.</span>junit<span class="token punctuation">.</span>Test<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>junit<span class="token punctuation">.</span>runner<span class="token punctuation">.</span>RunWith<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>Autowired<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span>test<span class="token punctuation">.</span>context<span class="token punctuation">.</span>SpringBootTest<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>data<span class="token punctuation">.</span>redis<span class="token punctuation">.</span>core<span class="token punctuation">.</span>RedisTemplate<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>test<span class="token punctuation">.</span>context<span class="token punctuation">.</span>junit4<span class="token punctuation">.</span>SpringRunner<span class="token punctuation">;</span>

<span class="token annotation punctuation">@RunWith</span><span class="token punctuation">(</span>SpringRunner<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@SpringBootTest</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ChanggouRedisDemoApplicationTests</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> RedisTemplate redisTemplate<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">contextLoads</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        redisTemplate<span class="token punctuation">.</span><span class="token function">boundValueOps</span><span class="token punctuation">(</span><span class="token string">"key111"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">"123"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>redisTemplate<span class="token punctuation">.</span><span class="token function">boundValueOps</span><span class="token punctuation">(</span><span class="token string">"key111"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre>
<h4 id="4-4-Redis的持久化"><a href="#4-4-Redis的持久化" class="headerlink" title="4.4 Redis的持久化"></a>4.4 Redis的持久化</h4><h5 id="4-4-1-redis的持久化介绍"><a href="#4-4-1-redis的持久化介绍" class="headerlink" title="4.4.1 redis的持久化介绍"></a>4.4.1 redis的持久化介绍</h5><p>​    Redis的数据都放在内存中。如果机器挂掉，内存的数据就不存在，数据不能恢复，严重影响使用。那么redis本身给我们提供了持久化机制。即时出现这样的问题，也能恢复数据。接下来我们来看下redis的两种持久化方</p>
<h5 id="4-4-2-开启RDB"><a href="#4-4-2-开启RDB" class="headerlink" title="4.4.2 开启RDB"></a>4.4.2 开启RDB</h5><p>RDB:  快照形式  （定期数据保存磁盘中）会产生一个dump.rdb文件,redis默认开启了RDB的持久化方式。</p>
<p>特点：会存在数据丢失，性能较好，用于数据备份。</p>
<p>如图：有一个文件产生</p>
<p><img src="/2020/03/26/chang-gou-shang-cheng-shi-zhan-shi-liu/1558590766000.png" alt></p>
<p>如图：redis.conf中 的默认的RDB的配置：</p>
<p><img src="/2020/03/26/chang-gou-shang-cheng-shi-zhan-shi-liu/1558590788839.png" alt></p>
<p>解释：</p>
<pre class=" language-properties"><code class="language-properties"><span class="token comment" spellcheck="true"># 在 900 秒内最少有 1 个 key 被改动，或者 300 秒内最少有 10 个 key 被改动，又或者 60 秒内最少有 1000 个 key 被改动，以上三个条件随便满足一个，就触发一次保存操作。</span>

<span class="token comment" spellcheck="true">#    if(在60秒之内有10000个keys发生变化时){</span>
<span class="token comment" spellcheck="true">#      进行镜像备份</span>
<span class="token comment" spellcheck="true">#    }else if(在300秒之内有10个keys发生了变化){</span>
<span class="token comment" spellcheck="true">#      进行镜像备份</span>
<span class="token comment" spellcheck="true">#    }else if(在900秒之内有1个keys发生了变化){</span>
<span class="token comment" spellcheck="true">#      进行镜像备份</span>
<span class="token comment" spellcheck="true">#    }</span></code></pre>
<h5 id="4-4-3-开启AOF"><a href="#4-4-3-开启AOF" class="headerlink" title="4.4.3 开启AOF"></a>4.4.3 开启AOF</h5><p>AOF : append only file . 所有对redis的操作命令记录在.aof文件中,如果想恢复数据，重新加载文件，执行文件中的命令即可。默认的情况下 redis没有开启，要想开启，必须配置。</p>
<p>特点：每秒保存，数据完整性比较好，耗费性能。</p>
<p>开启AOF: 如图 去掉注释</p>
<p><img src="/2020/03/26/chang-gou-shang-cheng-shi-zhan-shi-liu/1558590810611.png" alt></p>
<p>配置 AOF的执行策略:</p>
<p><img src="/2020/03/26/chang-gou-shang-cheng-shi-zhan-shi-liu/1558590827986.png" alt></p>
<p>always:总是执行</p>
<p>everysec:每秒钟执行(默认)</p>
<p>no:不执行。</p>
<p>如果随着时间的推移，AOF文件中的数据越来越大，所以需要进行重写也就是压缩。</p>
<p><img src="/2020/03/26/chang-gou-shang-cheng-shi-zhan-shi-liu/1558590856034.png" alt></p>
<p>如图所示：自动压缩的比例为：</p>
<p>100：上一次AOF文件达到100%的时候进行压缩</p>
<p>64mb ：压缩时最小的文件大小。</p>
<h5 id="4-4-4-模式的抉择应用场景介绍"><a href="#4-4-4-模式的抉择应用场景介绍" class="headerlink" title="4.4.4 模式的抉择应用场景介绍"></a>4.4.4 模式的抉择应用场景介绍</h5><p>AOF 和RDB对比：</p>
<table>
<thead>
<tr>
<th>命令</th>
<th>RDB</th>
<th>AOF</th>
</tr>
</thead>
<tbody><tr>
<td>启动优先级</td>
<td>低</td>
<td>高</td>
</tr>
<tr>
<td>体积</td>
<td>小</td>
<td>大</td>
</tr>
<tr>
<td>恢复速度</td>
<td>快</td>
<td>慢</td>
</tr>
<tr>
<td>数据安全性</td>
<td>丢数据</td>
<td>根据策略决定</td>
</tr>
</tbody></table>
<p>RDB的最佳策略：</p>
<ul>
<li>关闭 </li>
<li>集中管理（用于备份数据）</li>
<li>主从模式，从开。</li>
</ul>
<p>AOF的最佳策略：</p>
<ul>
<li>建议 开  每秒刷盘-&gt;aof日志文件中</li>
<li>AOF重写集中管理</li>
</ul>
<p>最佳的策略：</p>
<ul>
<li>小分片（max_memery 4G左右）</li>
<li>监控机器的负载</li>
</ul>
<h4 id="4-6-Redis哨兵模式"><a href="#4-6-Redis哨兵模式" class="headerlink" title="4.6 Redis哨兵模式"></a>4.6 Redis哨兵模式</h4><p>Redis在使用过程中服务器毫无征兆的宕机，是一个麻烦的事情，如何保证备份的机器是原始服务器的完整备份呢？这时候就需要哨兵和复制。</p>
<p>Sentinel（哨兵）可以管理多个Redis服务器，它提供了监控，提醒以及自动的故障转移的功能，</p>
<p>Replication（复制）则是负责让一个Redis服务器可以配备多个备份的服务器。</p>
<p>Redis也是利用这两个功能来保证Redis的高可用的</p>
<h5 id="4-6-1-Redis的主从复制实现高可用"><a href="#4-6-1-Redis的主从复制实现高可用" class="headerlink" title="4.6.1 Redis的主从复制实现高可用"></a>4.6.1 Redis的主从复制实现高可用</h5><p><img src="/2020/03/26/chang-gou-shang-cheng-shi-zhan-shi-liu/1558592619048.png" alt></p>
<p>如图，通过主从架构，一个主节点，两个从节点。</p>
<p>通过手动监控的方式，监控master的宕机，以及出现故障将故障转移的方式可以做到高可用。</p>
<p>比如：如果主节点宕机，我们手动监控到主节点的宕机，并将某一个Slave变成主节点。 但是这样话，如何手动监控也是很麻烦的事情。所以使用sentinel机制就可以解决了这个问题，Sentinel（哨兵）是Redis 的高可用性解决方案。</p>
<ul>
<li>它能自动进行故障转移。</li>
<li>客户端连接sentinel，不需要关系具体的master。</li>
<li>当master地址改变时由sentinel更新到客户端。</li>
</ul>
<p><img src="/2020/03/26/chang-gou-shang-cheng-shi-zhan-shi-liu/1558593335136.png" alt></p>
<p>架构原理如图：</p>
<p>1.多个sentinel 发现并确认master有问题。</p>
<p>2.sentinel内部选举领导</p>
<p>3.选举出slave作为新的master</p>
<p>4.通知其余的slave成为新master的slave</p>
<p>5.通知客户端 主从变化</p>
<p>6.如果老的master重新复活，那么成为新的master的slave</p>
<p>要实现上边的功能的主要细节主要有以下三个定时任务：</p>
<ol>
<li>每10秒，哨兵会向master和slave发送INFO命令(目的就是监控每一个节点信息)</li>
<li>每2秒，哨兵会向master库和slave的频道(<strong>sentinel</strong>:hello)发送自己的信息 （sentinel节点通过<strong>sentinel</strong>:hello频道进行信息交换，比如加入哨兵集群，分享自己节点数据）</li>
<li>每1秒，哨兵会向master和slave以及其他哨兵节点发送PING命令（目的就是 redis节点的状态监控，还有领导选举，主备切换选择等）</li>
</ol>
<p>策略总结：</p>
<p>​    1.尽量为 每一个节点部署一个哨兵</p>
<p>​    2.哨兵也要搭建集群（防止哨兵单点故障）</p>
<p>​    3.每一个节点都同时设置quorum的值超过半数（N/2）+1</p>
<p>面试常问的问题：</p>
<p>​    主从复制，以及哨兵 和集群之间区别。</p>
<p>主从复制 是redis实现高可用的一个策略。将会有主节点 和从节点，从节点的数据完整的从主节点中复制一份。</p>
<p>哨兵：当系统节点异常宕机的时候，开发者可以手动进行故障转移恢复，但是手动比较麻烦，所以通过哨兵机制自动进行监控和恢复。为了解决哨兵也会单点故障的问题，可以建立哨兵集群。</p>
<p>集群：即使使用哨兵，redis每个实例也是全量存储，每个redis存储的内容都是完整的数据，浪费内存且有木桶效应。为了最大化利用内存，可以采用集群，就是分布式存储。这个时候可以使用redis集群。将不同的数据分配到不同的节点中，这样就可以横向扩展，扩容。</p>
<h4 id="4-7-redis缓存击穿问题解决"><a href="#4-7-redis缓存击穿问题解决" class="headerlink" title="4.7 redis缓存击穿问题解决"></a>4.7 redis缓存击穿问题解决</h4><h5 id="4-7-1-什么是缓存击穿"><a href="#4-7-1-什么是缓存击穿" class="headerlink" title="4.7.1  什么是缓存击穿"></a>4.7.1  什么是缓存击穿</h5><p><img src="/2020/03/26/chang-gou-shang-cheng-shi-zhan-shi-liu/1558597517593.png" alt></p>
<p>如图：</p>
<pre><code>   1. 当用户根据key 查询数据时，先查询缓存，如果缓存有命中，返回，
   2. 但是如果缓存没有命中直接穿过缓存层，访问数据层 如果有，则存储指缓存，
   3. 但是同样如果没有命中，（也就是数据库中也没有数据）直接返回用户，但是不缓存</code></pre><p>这就是缓存的穿透。如果某一个key 请求量很大，但是存储层也没有数据，大量的请求都会达到存储层就会造成数据库压力巨大，有可能宕机的情况。</p>
<h5 id="4-7-2-缓存击穿的解决方案"><a href="#4-7-2-缓存击穿的解决方案" class="headerlink" title="4.7.2 缓存击穿的解决方案"></a>4.7.2 缓存击穿的解决方案</h5><p>如图：</p>
<p>1.当缓存中没有命中的时候，从数据库中获取</p>
<p>2.当数据库中也没有数据的时候，我们直接将null 作为值设置redis中的key上边。</p>
<p>3.此时如果没有数据，一般情况下都需要设置一个过期时间，例如：5分钟失效。（为了避免过多的KEY 存储在redis中）</p>
<p>4.返回给用户，</p>
<p>5.用户再次访问时，已经有KEY了。此时KEY的值是null而已，这样就可以在缓存中命中，解决了缓存穿透的问题。</p>
<p><img src="/2020/03/26/chang-gou-shang-cheng-shi-zhan-shi-liu/1558681487990.png" alt></p>
<p>（2）例如：代码如下：</p>
<p><img src="/2020/03/26/chang-gou-shang-cheng-shi-zhan-shi-liu/1558684609508.png" alt></p>
<p>注意：缓存空对象会有两个问题：</p>
<p>第一，空值做了缓存，意味着缓存层中存了更多的键，需要更多的内存空间 ( 如果是攻击，问题更严重 )，比较有效的方法是针对这类数据设置一个较短的过期时间，让其自动剔除。</p>
<p> 第二，缓存层和存储层的数据会有一段时间窗口的不一致，可能会对业务有一定影响。例如过期时间设置为 5分钟，如果此时存储层添加了这个数据，那此段时间就会出现缓存层和存储层数据的不一致，此时可以利用消息系统或者其他方式清除掉缓存层中的空对象。</p>
<h4 id="4-8-Redis缓存雪崩问题解决（作业）"><a href="#4-8-Redis缓存雪崩问题解决（作业）" class="headerlink" title="4.8 Redis缓存雪崩问题解决（作业）"></a>4.8 Redis缓存雪崩问题解决（作业）</h4><h5 id="4-8-1-什么是缓存雪崩"><a href="#4-8-1-什么是缓存雪崩" class="headerlink" title="4.8.1 什么是缓存雪崩"></a>4.8.1 什么是缓存雪崩</h5><p>  如果缓存集中在一段时间内失效，发生大量的缓存穿透，所有的查询都落在数据库上，造成了缓存雪崩。</p>
<h5 id="4-8-2-如何解决"><a href="#4-8-2-如何解决" class="headerlink" title="4.8.2 如何解决"></a>4.8.2 如何解决</h5><p>这个没有完美解决办法，但可以分析用户行为，尽量让失效时间点均匀分布。</p>
<ul>
<li>限流 加锁排队</li>
</ul>
<p>在缓存失效后，通过对某一个key加锁或者是队列 来控制key的线程访问的数量。例如：某一个key 只允许一个线程进行 操作。</p>
<ul>
<li>限流</li>
</ul>
<p>在缓存失效后，某一个key 做count统计限流，达到一定的阈值，直接丢弃，不再查询数据库。例如：令牌桶算法。等等。</p>
<ul>
<li>数据预热</li>
</ul>
<p>在缓存失效应当尽量避免某一段时间，可以先进行数据预热，比如某些热门的商品。提前在上线之前，或者开放给用户使用之前，先进行loading 缓存中，这样用户使用的时候，直接从缓存中获取。要注意的是，要更加业务来进行过期时间的设置 ，尽量均匀。</p>
<ul>
<li>做缓存降级（二级缓存策略）</li>
</ul>
<p>当分布式缓存失效的时候，可以采用本地缓存，本地缓存没有再查询数据库。这种方式，可以避免很多数据分布式缓存没有，就直接打到数据库的情况。</p>
<h5 id="4-8-3二级缓存解决雪崩的案例"><a href="#4-8-3二级缓存解决雪崩的案例" class="headerlink" title="4.8.3二级缓存解决雪崩的案例"></a>4.8.3二级缓存解决雪崩的案例</h5><p>分析：</p>
<p>​    基本的思路：通过redis缓存+mybatis的二级缓存整合ehcache来实现。</p>
<p>​    EhCache 是一个纯Java的进程内缓存框架，具有快速、精干等特点，是Hibernate中默认的CacheProvider。</p>
<p>（1）在原来的工程中加入依赖</p>
<pre class=" language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.mybatis.caches<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>mybatis-ehcache<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>1.1.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span></code></pre>
<p>（2）创建dao的接口 使用XML的方式</p>
<pre class=" language-java"><code class="language-java"><span class="token annotation punctuation">@Mapper</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">TbUserMapper</span> <span class="token punctuation">{</span>


    <span class="token comment" spellcheck="true">/**
     * 根据用户名查询用户的信息
     * @param username
     * @return
     */</span>
    <span class="token keyword">public</span> TbUser <span class="token function">findOne</span><span class="token punctuation">(</span>String username<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p>（3）创建TbUserMapper.xml，如图加入echache的配置 开启二级缓存</p>
<pre class=" language-xml"><code class="language-xml"><span class="token prolog">&lt;?xml version="1.0" encoding="UTF-8"?></span>
<span class="token doctype">&lt;!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd"></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>mapper</span> <span class="token attr-name">namespace</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>com.itheima.changgouredisdemo.dao.TbUserMapper<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
    <span class="token comment" spellcheck="true">&lt;!--加入使用缓存--></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>cache</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>org.mybatis.caches.ehcache.EhcacheCache<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
        <span class="token comment" spellcheck="true">&lt;!--缓存自创建日期起至失效时的间隔时间一个小时--></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>timeToIdleSeconds<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>3600<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
        <span class="token comment" spellcheck="true">&lt;!--缓存创建以后，最后一次访问缓存的日期至失效之时的时间间隔一个小时--></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>timeToLiveSeconds<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>3600<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
        <span class="token comment" spellcheck="true">&lt;!--设置在缓存中保存的对象的最大的个数，这个按照业务进行配置--></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>maxEntriesLocalHeap<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>1000<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>

        <span class="token comment" spellcheck="true">&lt;!--设置在磁盘中最大实体对象的个数--></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>maxEntriesLocalDisk<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>10000000<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
        <span class="token comment" spellcheck="true">&lt;!--缓存淘汰算法--></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>memoryStoreEvictionPolicy<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>LRU<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>cache</span><span class="token punctuation">></span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>select</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>findOne<span class="token punctuation">"</span></span> <span class="token attr-name">resultType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>com.itheima.changgouredisdemo.pojo.TbUser<span class="token punctuation">"</span></span> <span class="token attr-name">parameterType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>string<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
          SELECT * from tb_user where username = #{username}
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>select</span><span class="token punctuation">></span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>mapper</span><span class="token punctuation">></span></span>

</code></pre>
<p>（4）配置application.yml</p>
<p><img src="/2020/03/26/chang-gou-shang-cheng-shi-zhan-shi-liu/1558754573194.png" alt></p>
<pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">mybatis</span><span class="token punctuation">:</span>
  <span class="token key atrule">configuration</span><span class="token punctuation">:</span>
    <span class="token key atrule">map-underscore-to-camel-case</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token comment" spellcheck="true"># 指定mapper映射文件目录</span>
  <span class="token key atrule">mapper-locations</span><span class="token punctuation">:</span> classpath<span class="token punctuation">:</span>mapper/<span class="token important">*Mapper</span>.xml</code></pre>
<p>（5）创建controller service 来进行测试：</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>itheima<span class="token punctuation">.</span>changgouredisdemo<span class="token punctuation">.</span>controller<span class="token punctuation">;</span>

<span class="token keyword">import</span> com<span class="token punctuation">.</span>itheima<span class="token punctuation">.</span>changgouredisdemo<span class="token punctuation">.</span>pojo<span class="token punctuation">.</span>TbUser<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>itheima<span class="token punctuation">.</span>changgouredisdemo<span class="token punctuation">.</span>service<span class="token punctuation">.</span>UserService<span class="token punctuation">;</span>

<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>Autowired<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>PathVariable<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>RequestMapping<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>RestController<span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">/**
 * 描述
 *
 * @author 三国的包子
 * @version 1.0
 * @package com.itheima.changgouredisdemo.controller *
 * @since 1.0
 */</span>
<span class="token annotation punctuation">@RestController</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/user"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserController</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> UserService userService<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/findOne/{username}"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> TbUser <span class="token function">findOne</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span> String username<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> userService<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span>username<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span></code></pre>
<pre class=" language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>itheima<span class="token punctuation">.</span>changgouredisdemo<span class="token punctuation">.</span>service<span class="token punctuation">.</span>impl<span class="token punctuation">;</span>

<span class="token keyword">import</span> com<span class="token punctuation">.</span>itheima<span class="token punctuation">.</span>changgouredisdemo<span class="token punctuation">.</span>dao<span class="token punctuation">.</span>TbUserMapper<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>itheima<span class="token punctuation">.</span>changgouredisdemo<span class="token punctuation">.</span>pojo<span class="token punctuation">.</span>TbUser<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>itheima<span class="token punctuation">.</span>changgouredisdemo<span class="token punctuation">.</span>service<span class="token punctuation">.</span>UserService<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>Autowired<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>data<span class="token punctuation">.</span>redis<span class="token punctuation">.</span>core<span class="token punctuation">.</span>RedisTemplate<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span>Service<span class="token punctuation">;</span>

<span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span>TimeUnit<span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">/**
 * 描述
 *
 * @author 三国的包子
 * @version 1.0
 * @package com.itheima.changgouredisdemo.service.impl *
 * @since 1.0
 */</span>
<span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">UserService</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> TbUserMapper userMapper<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> RedisTemplate redisTemplate<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> TbUser <span class="token function">findOne</span><span class="token punctuation">(</span>String username<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        TbUser user <span class="token operator">=</span> <span class="token punctuation">(</span>TbUser<span class="token punctuation">)</span> redisTemplate<span class="token punctuation">.</span><span class="token function">boundValueOps</span><span class="token punctuation">(</span>username<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>redisTemplate<span class="token punctuation">.</span><span class="token function">hasKey</span><span class="token punctuation">(</span>username<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> user<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">//没有key 数据库中查询</span>
            TbUser one <span class="token operator">=</span> userMapper<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span>username<span class="token punctuation">)</span><span class="token punctuation">;</span>
            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"第一次查询数据库"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            redisTemplate<span class="token punctuation">.</span><span class="token function">boundValueOps</span><span class="token punctuation">(</span>username<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>one<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>one <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                redisTemplate<span class="token punctuation">.</span><span class="token function">expire</span><span class="token punctuation">(</span>username<span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">,</span> TimeUnit<span class="token punctuation">.</span>SECONDS<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> one<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p>(6)测试：</p>
<p>已知： 数据库中有zhangsan</p>
<p><img src="/2020/03/26/chang-gou-shang-cheng-shi-zhan-shi-liu/1558754733955.png" alt></p>
<p>准备好redis</p>
<p>浏览器输入</p>
<pre><code>http://localhost:9008/user/findOne/zhangsan</code></pre><p>效果：</p>
<p><img src="/2020/03/26/chang-gou-shang-cheng-shi-zhan-shi-liu/1558754805646.png" alt></p>
<p>redis中:    也有数据</p>
<p><img src="/2020/03/26/chang-gou-shang-cheng-shi-zhan-shi-liu/1558754843688.png" alt></p>
<p>此时：修改数据库的数据zhangsan为zhangsan5,并清空redis缓存。</p>
<p><img src="/2020/03/26/chang-gou-shang-cheng-shi-zhan-shi-liu/1558754887756.png" alt></p>
<p><img src="/2020/03/26/chang-gou-shang-cheng-shi-zhan-shi-liu/1558754905648.png" alt></p>
<p>再次输入浏览器地址：</p>
<pre><code>http://localhost:9008/user/findOne/zhangsan</code></pre><p>此时数据库总已经没有zhangsan,但是效果却是</p>
<p><img src="/2020/03/26/chang-gou-shang-cheng-shi-zhan-shi-liu/1558754956981.png" alt></p>
<p>说明数据从二级缓存中也就是本地缓存中获取到了，测试成功。</p>
<h3 id="第5章-RabbitMQ集群"><a href="#第5章-RabbitMQ集群" class="headerlink" title="第5章 RabbitMQ集群"></a>第5章 RabbitMQ集群</h3><p>在使用RabbitMQ的过程中，如果只有一个节点，但是一旦单机版宕机，服务不可用，影响比较严重，所以这里我们演示下如何搭建rabbitmq的集群，集群就能避免单点故障的问题。</p>
<p> RabbitMQ 集群分为两种 普通集群 和 镜像集群</p>
<h4 id="5-1普通集群"><a href="#5-1普通集群" class="headerlink" title="5.1普通集群"></a>5.1普通集群</h4><p>以两个节点（rabbit01、rabbit02）为例来进行说明。</p>
<p>rabbit01和rabbit02两个节点仅有相同的元数据，即队列的结构，但消息实体只存在于其中一个节点rabbit01（或者rabbit02）中。<br>​    当消息进入rabbit01节点的Queue后，consumer从rabbit02节点消费时，RabbitMQ会临时在rabbit01、rabbit02间进行消息传输，把A中的消息实体取出并经过B发送给consumer。</p>
<p>所以consumer应尽量连接每一个节点，从中取消息，即对于同一个逻辑队列，要在多个节点建立物理Queue；否则无论consumer连rabbit01或rabbit02，出口总在rabbit01，会产生瓶颈。</p>
<p>​    当rabbit01节点故障后，rabbit02节点无法取到rabbit01节点中还未消费的消息实体。如果做了消息持久化，那么得等rabbit01节点恢复，然后才可被消费；如果没有持久化的话，就会产生消息丢失的现象。</p>
<h4 id="5-2-镜像集群"><a href="#5-2-镜像集群" class="headerlink" title="5.2 镜像集群"></a>5.2 镜像集群</h4><p>​    在普通集群的基础上，把需要的队列做成镜像队列，消息实体会主动在镜像节点间同步，而不是在客户端取数据时临时拉取，也就是说多少节点消息就会备份多少份。该模式带来的副作用也很明显，除了降低系统性能外，如果镜像队列数量过多，加之大量的消息进入，集群内部的网络带宽将会被这种同步通讯大大消耗掉。所以在对可靠性要求较高的场合中适用</p>
<p>由于镜像队列之间消息自动同步，且内部有选举master机制，即使master节点宕机也不会影响整个集群的使用，达到去中心化的目的，从而有效的防止消息丢失及服务不可用等问题。</p>
<h4 id="5-3-集群搭建"><a href="#5-3-集群搭建" class="headerlink" title="5.3 集群搭建"></a>5.3 集群搭建</h4><p>准备两台虚拟机，虚拟机的地址分别为192.168.25.130, 192.168.25.134</p>
<p>设置192.168.25.130的别名为A：修改如下文件 名称改为A</p>
<pre><code>vi /etc/hostname</code></pre><p>设置192.168.25.134的别名为B,修改如下文件 名称改为B</p>
<pre><code>vi /etc/hostname</code></pre><p>修改每一个虚拟机的hosts</p>
<pre><code>vi /etc/hosts</code></pre><p>加入如下代码：</p>
<pre><code>192.168.25.130 A
192.168.25.134 B</code></pre><p>如下图所示：</p>
<p><img src="/2020/03/26/chang-gou-shang-cheng-shi-zhan-shi-liu/1558690182918.png" alt></p>
<p>重启系统。</p>
<h5 id="5-3-1-安装erlang"><a href="#5-3-1-安装erlang" class="headerlink" title="5.3.1 安装erlang"></a>5.3.1 安装erlang</h5><p>192.168.25.130上安装如下：</p>
<p>输入命令，下载erlang：</p>
<pre class=" language-shell"><code class="language-shell">wget http://www.rabbitmq.com/releases/erlang/erlang-18.1-1.el6.x86_64.rpm</code></pre>
<p>安装erlang，root用户使用rpm安装：</p>
<pre class=" language-shell"><code class="language-shell">rpm -ihv erlang-18.1-1.el6.x86_64.rpm</code></pre>
<h5 id="5-3-2-下载和安装RabbitMQ"><a href="#5-3-2-下载和安装RabbitMQ" class="headerlink" title="5.3.2 下载和安装RabbitMQ"></a>5.3.2 下载和安装RabbitMQ</h5><p>下载RabbitMQ:</p>
<pre class=" language-shell"><code class="language-shell">wget https://github.com/rabbitmq/rabbitmq-server/releases/download/rabbitmq_v3_6_12/rabbitmq-server-3.6.12-1.el6.noarch.rpm</code></pre>
<p>安装RabbitMQ,</p>
<ul>
<li>先安装socat</li>
</ul>
<pre><code>yum install -y socat</code></pre><ul>
<li>root用户使用rpm安装 安装rabbitmq</li>
</ul>
<pre><code>rpm -ihv rabbitmq-server-3.6.12-1.el6.noarch.rpm</code></pre><p>验证是否安装成功：</p>
<p>输入命令：</p>
<pre class=" language-shell"><code class="language-shell">[root@A ~]# rabbitmq-server</code></pre>
<p>出现如下界面，说明OK</p>
<p><img src="/2020/03/26/chang-gou-shang-cheng-shi-zhan-shi-liu/1558688657340.png" alt></p>
<p>守护进程启动方式：</p>
<pre><code>rabbitmq-server -detached</code></pre><p>其他相关指令：</p>
<pre><code>启动服务：rabbitmq-server -detached
查看状态：rabbitmqctl status
关闭服务：rabbitmqctl stop
列出角色：rabbitmqctl list_users
改密码: rabbimqctlchange_password {username} {newpassword}
删除用户: rabbitmqctl delete_user xx</code></pre><h5 id="5-3-3配置RabbitMQ"><a href="#5-3-3配置RabbitMQ" class="headerlink" title="5.3.3配置RabbitMQ"></a>5.3.3配置RabbitMQ</h5><p>（1）创建rabbitmq的账号</p>
<pre class=" language-shell"><code class="language-shell">[root@A ~]# rabbitmqctl add_user admin admin</code></pre>
<p>（2）将admin账号赋予管理员权限</p>
<pre class=" language-shell"><code class="language-shell">[root@A ~]# rabbitmqctl set_user_tags admin administrator</code></pre>
<p>（3）设置权限</p>
<pre class=" language-shell"><code class="language-shell">[root@A ~]# rabbitmqctl  set_permissions  -p  '/'  admin '.*' '.*' '.*'</code></pre>
<p>安装可视化界面</p>
<pre><code>rabbitmq-plugins enable rabbitmq_management</code></pre><h4 id="5-4-配置rabbitmq集群"><a href="#5-4-配置rabbitmq集群" class="headerlink" title="5.4 配置rabbitmq集群"></a>5.4 配置rabbitmq集群</h4><h5 id="5-4-1-安装rabbitmq"><a href="#5-4-1-安装rabbitmq" class="headerlink" title="5.4.1 安装rabbitmq"></a>5.4.1 安装rabbitmq</h5><p>安装方法如上边的方法进行在 192.168.25.134上进行</p>
<h5 id="5-4-2-保证相同的erlang-cookie"><a href="#5-4-2-保证相同的erlang-cookie" class="headerlink" title="5.4.2 保证相同的erlang cookie"></a>5.4.2 保证相同的erlang cookie</h5><p>erlang.cookie是erlang分布式的token文件，集群内所有的设备要持有相同的.erlang.cookie文件才允许彼此通信。</p>
<pre><code>scp /var/lib/rabbitmq/.erlang.cookie root@B:/var/lib/rabbitmq</code></pre><pre class=" language-shell"><code class="language-shell">[root@A rabbitmq]#  scp /var/lib/rabbitmq/.erlang.cookie root@A:/var/lib/rabbitmq 
The authenticity of host 'a (192.168.25.134)' can't be established.
ECDSA key fingerprint is cd:17:22:d1:10:81:d6:98:be:ad:cc:13:e0:0c:c3:03.
Are you sure you want to continue connecting (yes/no)? yes
Warning: Permanently added 'a,192.168.25.134' (ECDSA) to the list of known hosts.
root@a's password: 
.erlang.cookie                                                                                                                       100%   20     0.0KB/s   00:00    
[root@A rabbitmq]# </code></pre>
<h5 id="5-4-5-运行各个rabbitmq节点"><a href="#5-4-5-运行各个rabbitmq节点" class="headerlink" title="5.4.5 运行各个rabbitmq节点"></a>5.4.5 运行各个rabbitmq节点</h5><p>先停止每一个服务器的服务 </p>
<p>输入命令停止0</p>
<pre class=" language-shell"><code class="language-shell">[root@A rabbitmq]# rabbitmqctl stop</code></pre>
<p>再输入命令启动：</p>
<pre class=" language-shell"><code class="language-shell">[root@A rabbitmq]# rabbitmq-server -detached </code></pre>
<h5 id="5-4-6-查看状态"><a href="#5-4-6-查看状态" class="headerlink" title="5.4.6 查看状态"></a>5.4.6 查看状态</h5><pre class=" language-shell"><code class="language-shell">[root@A rabbitmq]# rabbitmqctl cluster_status</code></pre>
<h5 id="5-4-7-将节点连接成集群"><a href="#5-4-7-将节点连接成集群" class="headerlink" title="5.4.7 将节点连接成集群"></a>5.4.7 将节点连接成集群</h5><p>每一个服务器都关闭防火墙：</p>
<pre><code>[root@B ~]#  systemctl stop firewalld</code></pre><p>B加入到集群A中，在B中执行如下命令：</p>
<pre><code>[root@B ~]# rabbitmqctl stop_app
[root@B ~]# rabbitmqctl join_cluster rabbit@A
[root@B ~]# rabbitmqctl start_app</code></pre><p>A不需要加入到自己</p>
<p>查看集群状态：在任意服务器上执行：</p>
<pre><code>rabbitmqctl cluster_status</code></pre><p>添加集群之前：</p>
<p><img src="/2020/03/26/chang-gou-shang-cheng-shi-zhan-shi-liu/1558692832020.png" alt></p>
<p>添加集群之后：</p>
<p><img src="/2020/03/26/chang-gou-shang-cheng-shi-zhan-shi-liu/1558692804680.png" alt></p>
<h5 id="5-4-8-配置单web插件查看集群"><a href="#5-4-8-配置单web插件查看集群" class="headerlink" title="5.4.8 配置单web插件查看集群"></a>5.4.8 配置单web插件查看集群</h5><p>在A服务器执行命令：</p>
<pre class=" language-shell"><code class="language-shell">rabbitmq-plugins enable rabbitmq_management</code></pre>
<p>在B服务器执行命令：</p>
<pre class=" language-shell"><code class="language-shell">rabbitmq-plugins enable rabbitmq_management</code></pre>
<p>在浏览器中输入A服务器的rabbitmq服务器地址：</p>
<pre><code>http://192.168.25.130:15672</code></pre><p>输入用户名和密码登录，如果登录失败，采取如下措施：</p>
<ul>
<li>执行命令 设置guest为管理员</li>
</ul>
<pre><code>rabbitmqctl set_user_tags guest administrator</code></pre><ul>
<li>执行命令 设置权限</li>
</ul>
<pre><code>rabbitmqctl set_permissions -p / guest &#39;.*&#39; &#39;.*&#39; &#39;.*&#39;</code></pre><ul>
<li>在rabbitmq的配置文件目录下创建一个rabbitmq.config文件</li>
</ul>
<pre><code>cd /etc/rabbitmq
vi rabbitmq.config</code></pre><p>输入如下文本，并保存：</p>
<pre><code> [{rabbit, [{loopback_users, []}]}]. </code></pre><p>重新启动服务：</p>
<pre><code>service rabbitmq-server restart</code></pre><p>再次输入地址 出现界面，说明集群搭建成功。</p>
<p><img src="/2020/03/26/chang-gou-shang-cheng-shi-zhan-shi-liu/1558709138262.png" alt></p>
<p>如有需要，同理 对服务B的配置如上边一样配置一遍即可。</p>
<h4 id="5-5-配置镜像队列"><a href="#5-5-配置镜像队列" class="headerlink" title="5.5 配置镜像队列"></a>5.5 配置镜像队列</h4><p>如上，我们已经搭建好了集群，但是并不能做到高可用，所以需要配置升级为镜像队列。</p>
<p>在任意的节点（A或者B）中执行如下命令：</p>
<pre><code>rabbitmqctl set_policy ha-all &quot;^&quot; &#39;{&quot;ha-mode&quot;:&quot;all&quot;}&#39;</code></pre><pre><code>解释
rabbitmqctl set_policy 
    用于设置策略
ha-all 
    表示设置为镜像队列并策略为所有节点可用 ，意味着 队列会被（同步）到所有的节点，当一个节点被加入到集群中时，也会同步到新的节点中，此策略比较保守，性能相对低，对接使用半数原则方式设置（N/2+1），例如：有3个结点 此时可以设置为：ha-two 表示同步到2个结点即可。
&quot;^&quot;  表示针对的队列的名称的正则表达式，此处表示匹配所有的队列名称
&#39;{&quot;ha-mode&quot;:&quot;all&quot;}&#39; 设置一组key/value的JSON 设置为高可用模式 匹配所有exchange</code></pre><p>此时查看web管理界面：添加一个队列itcast111,如下图已经可以出现结果为有一个结点，并且是ha-all模式（镜像队列模式）</p>
<p><img src="/2020/03/26/chang-gou-shang-cheng-shi-zhan-shi-liu/1558710954128.png" alt></p>
<h4 id="5-6-springboot整合rabbitmq集群使用-作业"><a href="#5-6-springboot整合rabbitmq集群使用-作业" class="headerlink" title="5.6 springboot整合rabbitmq集群使用(作业)"></a>5.6 springboot整合rabbitmq集群使用(作业)</h4><p>修改原来redis测试的项目，</p>
<p>(1)加入pom.xml依赖</p>
<pre class=" language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-boot-starter-amqp<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>2.1.4.RELEASE<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span></code></pre>
<p>（2）配置application.yml</p>
<pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">rabbitmq</span><span class="token punctuation">:</span>
    <span class="token key atrule">addresses</span><span class="token punctuation">:</span> 192.168.25.130<span class="token punctuation">:</span><span class="token number">5672</span><span class="token punctuation">,</span>192.168.25.134<span class="token punctuation">:</span><span class="token number">5672</span>
    <span class="token key atrule">username</span><span class="token punctuation">:</span> guest
    <span class="token key atrule">password</span><span class="token punctuation">:</span> guest</code></pre>
<p>(3)创建controller </p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>itheima<span class="token punctuation">.</span>changgouredisdemo<span class="token punctuation">.</span>controller<span class="token punctuation">;</span>

<span class="token keyword">import</span> com<span class="token punctuation">.</span>itheima<span class="token punctuation">.</span>changgouredisdemo<span class="token punctuation">.</span>pojo<span class="token punctuation">.</span>TbUser<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>itheima<span class="token punctuation">.</span>changgouredisdemo<span class="token punctuation">.</span>service<span class="token punctuation">.</span>UserService<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>amqp<span class="token punctuation">.</span>rabbit<span class="token punctuation">.</span>core<span class="token punctuation">.</span>RabbitTemplate<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>Autowired<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>PathVariable<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>RequestMapping<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>RestController<span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">/**
 * 描述
 *
 * @author 三国的包子
 * @version 1.0
 * @package com.itheima.changgouredisdemo.controller *
 * @since 1.0
 */</span>
<span class="token annotation punctuation">@RestController</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/user"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserController</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> UserService userService<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/findOne/{username}"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> TbUser <span class="token function">findOne</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span> String username<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> userService<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span>username<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> RabbitTemplate rabbitTemplate<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/send"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> String <span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        rabbitTemplate<span class="token punctuation">.</span><span class="token function">convertAndSend</span><span class="token punctuation">(</span><span class="token string">"itcast111"</span><span class="token punctuation">,</span><span class="token string">"hello"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token string">"ok"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre>
<p>(4)设置监听：</p>
<p>代码：</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>itheima<span class="token punctuation">.</span>changgouredisdemo<span class="token punctuation">.</span>listener<span class="token punctuation">;</span>

<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>amqp<span class="token punctuation">.</span>rabbit<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>RabbitHandler<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>amqp<span class="token punctuation">.</span>rabbit<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>RabbitListener<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span>Component<span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">/**
 * 描述
 *
 * @author 三国的包子
 * @version 1.0
 * @package com.itheima.changgouredisdemo.listener *
 * @since 1.0
 */</span>
<span class="token annotation punctuation">@Component</span>
<span class="token annotation punctuation">@RabbitListener</span><span class="token punctuation">(</span>queues <span class="token operator">=</span> <span class="token string">"itcast111"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Lisnter</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@RabbitHandler</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">getInfo</span><span class="token punctuation">(</span>String message<span class="token punctuation">)</span><span class="token punctuation">{</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"123131"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


<span class="token punctuation">}</span></code></pre>
<p>测试，在浏览器中输入：</p>
<pre><code>http://localhost:9008/user/send</code></pre><p>测试当宕机一台rabbitmq也能发送成功。</p>
<p>如下效果。</p>
<p><img src="/2020/03/26/chang-gou-shang-cheng-shi-zhan-shi-liu/1558712149146.png" alt></p>

            </div>
            <hr/>

            

    <div class="reprint" id="reprint-statement">
        
            <div class="reprint__author">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-user">
                        文章作者:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="https://fangpeng12.github.io" rel="external nofollow noreferrer">fangpeng</a>
                </span>
            </div>
            <div class="reprint__type">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-link">
                        文章链接:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="https://fangpeng12.github.io/2020/03/26/chang-gou-shang-cheng-shi-zhan-shi-liu/">https://fangpeng12.github.io/2020/03/26/chang-gou-shang-cheng-shi-zhan-shi-liu/</a>
                </span>
            </div>
            <div class="reprint__notice">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-copyright">
                        版权声明:
                    </i>
                </span>
                <span class="reprint-info">
                    本博客所有文章除特別声明外，均采用
                    <a href="https://creativecommons.org/licenses/by/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY 4.0</a>
                    许可协议。转载请注明来源
                    <a href="https://fangpeng12.github.io" target="_blank">fangpeng</a>
                    !
                </span>
            </div>
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>复制成功，请遵循本文的转载规则</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">查看</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>



            <div class="tag_share" style="display: block;">
                <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                            
                                <a href="/tags/%E5%BE%AE%E6%9C%8D%E5%8A%A1/">
                                    <span class="chip bg-color">微服务</span>
                                </a>
                            
                                <a href="/tags/SpringCloud/">
                                    <span class="chip bg-color">SpringCloud</span>
                                </a>
                            
                                <a href="/tags/%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98/">
                                    <span class="chip bg-color">项目实战</span>
                                </a>
                            
                        </div>
                    
                </div>
                <div class="post_share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">

<div id="article-share">
    
    
    <div class="social-share" data-sites="twitter,facebook,google,qq,qzone,wechat,weibo,douban,linkedin" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="/libs/share/js/social-share.min.js"></script>
    

    

</div>

                </div>
            </div>
            
                <style>
    #reward {
        margin: 40px 0;
        text-align: center;
    }

    #reward .reward-link {
        font-size: 1.4rem;
        line-height: 38px;
    }

    #reward .btn-floating:hover {
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2), 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    #rewardModal {
        width: 320px;
        height: 350px;
    }

    #rewardModal .reward-title {
        margin: 15px auto;
        padding-bottom: 5px;
    }

    #rewardModal .modal-content {
        padding: 10px;
    }

    #rewardModal .close {
        position: absolute;
        right: 15px;
        top: 15px;
        color: rgba(0, 0, 0, 0.5);
        font-size: 1.3rem;
        line-height: 20px;
        cursor: pointer;
    }

    #rewardModal .close:hover {
        color: #ef5350;
        transform: scale(1.3);
        -moz-transform:scale(1.3);
        -webkit-transform:scale(1.3);
        -o-transform:scale(1.3);
    }

    #rewardModal .reward-tabs {
        margin: 0 auto;
        width: 210px;
    }

    .reward-tabs .tabs {
        height: 38px;
        margin: 10px auto;
        padding-left: 0;
    }

    .reward-content ul {
        padding-left: 0 !important;
    }

    .reward-tabs .tabs .tab {
        height: 38px;
        line-height: 38px;
    }

    .reward-tabs .tab a {
        color: #fff;
        background-color: #ccc;
    }

    .reward-tabs .tab a:hover {
        background-color: #ccc;
        color: #fff;
    }

    .reward-tabs .wechat-tab .active {
        color: #fff !important;
        background-color: #22AB38 !important;
    }

    .reward-tabs .alipay-tab .active {
        color: #fff !important;
        background-color: #019FE8 !important;
    }

    .reward-tabs .reward-img {
        width: 210px;
        height: 210px;
    }
</style>

<div id="reward">
    <a href="#rewardModal" class="reward-link modal-trigger btn-floating btn-medium waves-effect waves-light red">赏</a>

    <!-- Modal Structure -->
    <div id="rewardModal" class="modal">
        <div class="modal-content">
            <a class="close modal-close"><i class="fas fa-times"></i></a>
            <h4 class="reward-title">你的赏识是我前进的动力</h4>
            <div class="reward-content">
                <div class="reward-tabs">
                    <ul class="tabs row">
                        <li class="tab col s6 alipay-tab waves-effect waves-light"><a href="#alipay">支付宝</a></li>
                        <li class="tab col s6 wechat-tab waves-effect waves-light"><a href="#wechat">微 信</a></li>
                    </ul>
                    <div id="alipay">
                        <img src="/medias/reward/alipay.jpg" class="reward-img" alt="支付宝打赏二维码">
                    </div>
                    <div id="wechat">
                        <img src="/medias/reward/wechat.png" class="reward-img" alt="微信打赏二维码">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    $(function () {
        $('.tabs').tabs();
    });
</script>
            
        </div>
    </div>

    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fas fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/2020/03/27/java-han-shu-shi-bian-cheng/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/17.jpg" class="responsive-img" alt="Java函数式编程">
                        
                        <span class="card-title">Java函数式编程</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            Java函数式编程入门和使用
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="far fa-clock fa-fw icon-date"></i>2020-03-27
                        </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/Java/" class="post-category">
                                    Java
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/Java/">
                        <span class="chip bg-color">Java</span>
                    </a>
                    
                    <a href="/tags/%E5%87%BD%E6%95%B0%E5%BC%8F%E7%BC%96%E7%A8%8B/">
                        <span class="chip bg-color">函数式编程</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2020/03/26/chang-gou-shang-cheng-shi-zhan-shi-wu/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/5.jpg" class="responsive-img" alt="畅购商城（十五）之分布式事务">
                        
                        <span class="card-title">畅购商城（十五）之分布式事务</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            畅购商城-SpringCloud微服务项目实战
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2020-03-26
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98/" class="post-category">
                                    项目实战
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/%E5%BE%AE%E6%9C%8D%E5%8A%A1/">
                        <span class="chip bg-color">微服务</span>
                    </a>
                    
                    <a href="/tags/SpringCloud/">
                        <span class="chip bg-color">SpringCloud</span>
                    </a>
                    
                    <a href="/tags/%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98/">
                        <span class="chip bg-color">项目实战</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>


<script>
    $('#articleContent').on('copy', function (e) {
        // IE8 or earlier browser is 'undefined'
        if (typeof window.getSelection === 'undefined') return;

        var selection = window.getSelection();
        // if the selection is short let's not annoy our users.
        if (('' + selection).length < Number.parseInt('120')) {
            return;
        }

        // create a div outside of the visible area and fill it with the selected text.
        var bodyElement = document.getElementsByTagName('body')[0];
        var newdiv = document.createElement('div');
        newdiv.style.position = 'absolute';
        newdiv.style.left = '-99999px';
        bodyElement.appendChild(newdiv);
        newdiv.appendChild(selection.getRangeAt(0).cloneContents());

        // we need a <pre> tag workaround.
        // otherwise the text inside "pre" loses all the line breaks!
        if (selection.getRangeAt(0).commonAncestorContainer.nodeName === 'PRE') {
            newdiv.innerHTML = "<pre>" + newdiv.innerHTML + "</pre>";
        }

        var url = document.location.href;
        newdiv.innerHTML += '<br />'
            + '来源: 空白格的博客<br />'
            + '文章作者: fangpeng<br />'
            + '文章链接: <a href="' + url + '">' + url + '</a><br />'
            + '本文章著作权归作者所有，任何形式的转载都请注明出处。';

        selection.selectAllChildren(newdiv);
        window.setTimeout(function () {bodyElement.removeChild(newdiv);}, 200);
    });
</script>


<!-- 代码块功能依赖 -->
<script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script>

<!-- 代码语言 -->

<script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script>

    
<!-- 代码块复制 -->

<script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>


<!-- 代码块收缩 -->

<script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script>


<!-- 代码块折行 -->

<style type="text/css">
code[class*="language-"], pre[class*="language-"] { white-space: pre !important; }
</style>

    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget">
            <div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fas fa-list-ul"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            // headingsOffset: -205,
            headingSelector: 'h2, h3, h4'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h2, h3, h4').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>



    <footer class="page-footer bg-color">
    <div class="container row center-align">
        <div class="col s12 m8 l8 copy-right">
            Copyright&nbsp;&copy;
            <span id="year">年份</span>
            <a href="https://fangpeng12.github.io" target="_blank">fangpeng</a>
            |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a>
            |&nbsp;Theme&nbsp;<a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>
            <br>
            
            &nbsp;<i class="fas fa-chart-area"></i>&nbsp;站点总字数:&nbsp;<span
                class="white-color">806.8k</span>&nbsp;字
            
            
            
            
            
            
            <span id="busuanzi_container_site_pv">
                |&nbsp;<i class="far fa-eye"></i>&nbsp;总访问量:&nbsp;<span id="busuanzi_value_site_pv"
                    class="white-color"></span>&nbsp;次
            </span>
            
            
            <span id="busuanzi_container_site_uv">
                |&nbsp;<i class="fas fa-users"></i>&nbsp;总访问人数:&nbsp;<span id="busuanzi_value_site_uv"
                    class="white-color"></span>&nbsp;人
            </span>
            
            <br>
            
            <span id="sitetime">载入运行时间...</span>
            <script>
                function siteTime() {
                    window.setTimeout("siteTime()", 1000);
                    var seconds = 1000;
                    var minutes = seconds * 60;
                    var hours = minutes * 60;
                    var days = hours * 24;
                    var years = days * 365;
                    var today = new Date();
                    var startYear = "2019";
                    var startMonth = "12";
                    var startDate = "21";
                    var startHour = "0";
                    var startMinute = "0";
                    var startSecond = "0";
                    var todayYear = today.getFullYear();
                    var todayMonth = today.getMonth() + 1;
                    var todayDate = today.getDate();
                    var todayHour = today.getHours();
                    var todayMinute = today.getMinutes();
                    var todaySecond = today.getSeconds();
                    var t1 = Date.UTC(startYear, startMonth, startDate, startHour, startMinute, startSecond);
                    var t2 = Date.UTC(todayYear, todayMonth, todayDate, todayHour, todayMinute, todaySecond);
                    var diff = t2 - t1;
                    var diffYears = Math.floor(diff / years);
                    var diffDays = Math.floor((diff / days) - diffYears * 365);
                    var diffHours = Math.floor((diff - (diffYears * 365 + diffDays) * days) / hours);
                    var diffMinutes = Math.floor((diff - (diffYears * 365 + diffDays) * days - diffHours * hours) /
                        minutes);
                    var diffSeconds = Math.floor((diff - (diffYears * 365 + diffDays) * days - diffHours * hours -
                        diffMinutes * minutes) / seconds);
                    if (startYear == todayYear) {
                        document.getElementById("year").innerHTML = todayYear;
                        document.getElementById("sitetime").innerHTML = "本站已安全运行 " + diffDays + " 天 " + diffHours +
                            " 小时 " + diffMinutes + " 分钟 " + diffSeconds + " 秒";
                    } else {
                        document.getElementById("year").innerHTML = startYear + " - " + todayYear;
                        document.getElementById("sitetime").innerHTML = "本站已安全运行 " + diffYears + " 年 " + diffDays +
                            " 天 " + diffHours + " 小时 " + diffMinutes + " 分钟 " + diffSeconds + " 秒";
                    }
                }
                setInterval(siteTime, 1000);
            </script>
            
            <br>
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/fangpeng12" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fab fa-github"></i>
    </a>















    <a href="/atom.xml" class="tooltipped" target="_blank" data-tooltip="RSS 订阅" data-position="top" data-delay="50">
        <i class="fas fa-rss"></i>
    </a>

</div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script src="/js/search.js"></script>
<script type="text/javascript">
$(function () {
    searchFunc("/" + "search.xml", 'searchInput', 'searchResult');
});
</script>
    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    <!-- Global site tag (gtag.js) - Google Analytics -->


    <!-- Baidu Analytics -->

    <!-- Baidu Push -->

<script>
    (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>

    
    <script src="/libs/others/clicklove.js" async="async"></script>
    
    
    <script async src="/libs/others/busuanzi.pure.mini.js"></script>
    

    

    

    

    

    
    <script type="text/javascript" src="/libs/background/ribbon-dynamic.js" async="async"></script>
    
    
    
    <script src="/libs/instantpage/instantpage.js" type="module"></script>
    

</body>

</html>
